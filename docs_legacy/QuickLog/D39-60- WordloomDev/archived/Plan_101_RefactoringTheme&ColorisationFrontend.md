Wordloom Theme 模块设计与实现计划
模块概述
Wordloom 的 Theme 模块负责管理书籍的视觉主题，根据书籍封面和成熟度阶段动态确定颜色和图标等元素。该模块将所有视觉映射逻辑集中在一起，以纯函数方式提供服务，没有外部依赖和副作用。这意味着相同输入将产生相同输出，不修改任何全局状态或持久数据。通过 Theme 模块，可以确保前后端在任何场景下对书籍的颜色与图标渲染保持一致，易于维护和扩展。
模块作用范围
Theme 模块的功能范围包括以下几个方面：
封面颜色提取：支持从书籍封面图像中自动提取主色调，并允许用户自定义覆盖或使用默认颜色作为后备方案，按照“用户指定 > 自动提取 > 默认颜色”三层优先级确定封面主题色。
成熟度阶段映射：根据书籍所处的成熟度阶段（例如 seed 阶段、growing 阶段、stable 阶段等），映射到预定义的颜色和图标。例如：seed 阶段对应灰色，growing 对应蓝色，stable 对应绿色等，以及相应的阶段图标。
图标展示逻辑：根据书籍所处阶段决定采用何种类型的图标。对于进入 stable 稳定阶段之前的书籍，使用 Lucide 图标库中的矢量图标进行表示；而达到 stable 稳定阶段及之后，则使用用户通过媒体模块上传的专属图标图像来表示，以体现更个性化的标识。
映射配置集中管理：将上述颜色、图标、阶段—视觉元素之间的映射关系整理为统一的配置项集中管理。通过单一配置文件维护颜色表、图标表以及成熟度阶段到视觉元素的对应关系，避免散落硬编码，方便日后调整主题风格。
功能接口（纯函数库）
Theme 模块设计为一个纯函数库，不引入数据库或外部服务，其函数对相同输入始终返回相同结果且不产生副作用。模块提供以下主要功能接口：
getCoverColor(input)：
功能：获取书籍封面主题色。按照用户指定 > 自动提取 > 默认值的顺序决策最终颜色。
参数：input 可包含封面图片的引用（如 URL）以及用户自定义颜色配置等信息。例如可以传入封面图像URL和（可选的）用户指定颜色值。
返回：返回封面颜色的表示值（如 HEX 色码字符串或 RGB 数组）。
实现逻辑：函数首先检查用户是否为该书显式设置了主题颜色，如果有则直接返回该颜色；否则如果提供了封面图像URL，则对图像执行主色提取算法计算出主色调；若无法提取（没有封面图或提取失败），则返回配置的默认封面颜色。自动提取主色可以借助常见的图像颜色量化算法（如中值切割算法或 K-Means 聚类算法）来获取图片的主导色
cloud.tencent.com
。例如，可使用类似 ColorThief 库采用的 MMCQ 算法从封面图像提取主色
processwire.com
。整个过程纯计算，不改动任何全局状态。
getStageVisual(stage)：
功能：获取指定成熟度阶段对应的视觉元素配置，包括颜色和图标。
参数：stage 表示成熟度阶段的标识（例如 "seed", "growing", "stable" 等）。
返回：返回一个包含该阶段颜色值和图标信息的对象。例如 { color: '#008000', icon: 'sprout' }（其中 icon 在稳定前阶段为 Lucide 图标名称，在稳定阶段则可能只是占位，实际图标由用户上传）。
实现逻辑：函数在内部查找静态配置中该阶段对应的颜色和默认图标。对于非稳定阶段，直接使用配置中的 Lucide 图标名称；对于稳定（stable）阶段，由于约定使用上传的专属图标，函数可返回配置的颜色以及指示使用自定义图像图标的占位符（例如返回一个特殊的 iconType 标志表示需从媒体获取图像）。配置中预先定义每个阶段的颜色/图标映射，此函数只是纯查表操作，将映射结果返回，不进行额外运算或外部调用。
getBookTheme(book)：
功能：综合获取书籍当前的主题视觉配置。调用前两个函数并结合业务规则，返回该书籍应使用的封面颜色、阶段图标及其呈现方式等完整信息。
参数：book 对象，包含书籍所需的相关信息，例如封面图片URL、用户自定义主题色、成熟度阶段标识，及（如果有）稳定阶段的自定义图标URL等。
返回：包含书籍主题视觉元素的结构化对象，例如：
{
  "color": "#008000",
  "icon": "sprout",
  "iconType": "lucide"
}
表示该书使用绿色作为主题色，图标采用 Lucide 库中的 "sprout" 图标（iconType 指明这是一个 Lucide 图标）。如果阶段为稳定且存在自定义图像图标，返回的对象可能形如：
{
  "color": "#008000",
  "icon": "https://media.myapp.com/book-icons/123.png",
  "iconType": "image"
}
（其中 icon 给出图像URL，iconType表明这是一个图片）。
实现逻辑：getBookTheme 内部依次调用前述的 getCoverColor 获取封面颜色，和 getStageVisual 获取阶段基础视觉配置。然后根据返回结果和书籍状态综合决定最终图标：如果书籍阶段尚未稳定，则直接使用 Lucide 图标；如果已进入稳定阶段且书籍有自定义图标URL，可覆盖默认的Lucide图标，改用该图像作为图标。函数不进行IO或数据存储，仅整合其他纯函数结果并决策，生成最终用于前端显示的主题配置数据。
mapLucideIconFromTag(tag)：
功能：将用户定义的某个标签（tag）映射为推荐的 Lucide 图标 名称，用于在界面上直观表示该标签含义。
参数：tag 字符串，即用户自定义的分类或标签名称。
返回：一个字符串，表示建议采用的 Lucide 图标名称。例如传入 "science" 可能返回 "atom"，传入 "history" 返回 "book" 等（具体映射关系在配置中定义）。如果给定的 tag 在映射表中没有对应图标，函数可返回一个默认的通用标签图标名称（如 "tag" 图标）。
实现逻辑：该函数查找配置文件中维护的 tag -> Lucide 图标映射表，根据输入的标签关键字找到匹配的图标名称。匹配时可以考虑大小写或部分匹配（具体策略可按需求设计，如完全匹配或提供关键词包含）。例如配置里有 "security": "shield" 则传入 security 或相关词时返回 "shield" 图标名。此函数同样是纯查表，不依赖外部服务。当找不到对应映射时，返回预设的默认图标名称以保证有输出。
视觉映射配置（theme.config）
为方便维护，Theme 模块将所有颜色、图标等映射关系集中在配置文件中（如 theme.config.ts 或 theme.config.json），由此模块读取使用。该配置模块包含以下内容：
阶段到颜色/Icon 的映射：定义各成熟度 stage 名称对应的主题色值和默认图标。其中颜色通常使用 HEX 色码或 CSS 变量，图标使用 Lucide 图标的名称字符串（稳定阶段可特殊标注）。例如：
stageToVisual: {
  seed:   { color: "#808080", icon: "sprout" },   // 灰色，幼苗图标
  growing:{ color: "#3A85FF", icon: "leaf" },    // 蓝色，树叶图标
  stable: { color: "#2DA44E", icon: "award" }    // 绿色，奖章图标 (或标记为需替换为用户图像)
}
上述映射集中规定了各阶段的默认视觉标识。当书籍进入 stable 阶段后，实际使用图标可能由用户上传图像替代，配置里的 stable.icon 可视为占位符或默认值。颜色和图标映射在此集中管理有利于统一调整，比如日后修改某阶段颜色只需改这里。
默认颜色配置：定义当封面没有可用图像且用户又未指定任何颜色时所使用的回退默认颜色。这可以是一个全局默认主题色值，也可以按需细分。例如全局设定 defaultCoverColor: "#cccccc" 作为通用默认封面背景色；或者针对不同分类/阶段也可各有默认色。Theme 模块在 getCoverColor 中会使用此配置作为最后兜底。
标签到 Lucide 图标映射：定义常见用户标签关键字映射到推荐的 Lucide 图标。例如：
tagIconMap: {
  science: "atom",
  history: "book-open",
  security: "shield",
  fantasy: "moon",
  // ...etc
}
这为 mapLucideIconFromTag 提供数据支持。当用户添加新的标签时，可在配置中扩充相应映射，以便前端显示更贴切的图标。Lucide 图标库非常丰富（提供了1000+个开源矢量图标
github.com
），可以挑选符合标签含义的图标填入此表。
保留映射/规则：包含一些与视觉呈现相关的固定规则或路径前缀。例如，用户上传的自定义图标在媒体服务器上的存储路径规则：如统一保存在 /media/book-icons/ 目录下，以书籍ID命名文件。可在配置中提供一个基础 URL 模板，如：customIconBasePath: "https://media.example.com/book-icons/"，供 Theme 模块在需要拼接自定义图标完整URL时使用（如果 book 对象仅存了文件名或ID）。另外，若有保留的关键字或特殊标签需要特殊处理的图标/颜色映射，也可在此配置说明。该配置模块本身不包含可执行逻辑，仅作为数据源，由 Theme 模块读取。通过集中配置，所有视觉映射关系都清晰可见且易于修改。
模块集成与边界
Theme 模块作为中间层的纯计算服务，与其他系统组件通过明确的接口交互，边界清晰：
无状态与无持久化：Theme 模块不连接数据库，也不维护内部缓存或状态。每次调用均根据提供的参数即时计算并返回结果，不保留任何计算痕迹。这保证了模块的可预测性和易测试性（相同输入永远得到相同输出），同时减少了模块间耦合。
与成熟度逻辑的集成：业务层在确定书籍的成熟度阶段（maturity stage）后，会调用 Theme 模块来获取对应的视觉表现数据。例如，当书籍由 growing 升级到 stable 时，业务逻辑更新阶段后，通过 getStageVisual("stable") 获取该阶段的颜色和默认图标，再结合书籍是否有自定义图标来决定最终展示。这种分离使得成熟度阶段的计算与其显示逻辑解耦：阶段计算只关注规则，视觉呈现完全委托给 Theme 模块完成。
在时间线（Chronicle）中的应用：时间线功能需要展示每个事件所对应的阶段标识图标和颜色。这部分也由 Theme 模块提供支持。时间线模块在生成事件视图时，根据事件所属阶段调用 getStageVisual(stage) 获取统一的阶段图标（如种子、树苗、树等图标）和颜色，用于在时间轴上做区分标记。对于处于稳定期的重要事件，若需要展示专属图标，则可通过书籍或事件记录中附带的图像URL来替换默认的Lucide图标。这样，时间线上的视觉元素与书籍页面上的一致，且映射关系集中管理。
前端对 Theme 模块的使用：由于 Theme 模块设计为纯函数库，实现上可以在后端服务中调用，也可以在前端环境直接使用（例如作为前端的一份配置/工具脚本）。前端页面在渲染书籍详情时，会通过调用封装好的 theme-pure.ts 接口（其实即上述函数）获取书籍的颜色和图标。例如：
const theme = getBookTheme(bookData);
element.style.backgroundColor = theme.color;
if(theme.iconType === 'lucide') {
    renderLucideIcon(theme.icon);  // 渲染对应名称的Lucide矢量图标
} else if(theme.iconType === 'image') {
    imgElement.src = theme.icon;   // 加载自定义图标图像
}
通过这样的调用，前端无需关心颜色如何提取、图标如何映射，只根据 Theme 模块返回的数据进行展示即可。由于配置集中且函数纯净，前端呈现将始终与配置保持一致。
与媒体模块的边界：封面图像的存储和处理由Media 模块专职负责。Theme 模块对于图像的了解仅限于一个可访问的 URL 或路径字符串。例如，getCoverColor 会接受一个图像URL作为参数，但不会涉及如何存取图像文件数据。当需要对封面图提取主色时，可以由 Media 模块提供辅助（如预先计算好的主色，或者确保URL可读取），或在 Theme 模块中使用纯前端手段加载图像进行分析。无论如何，Theme 模块本身不执行文件I/O操作，不维护图像数据，只基于提供的URL进行计算。这种边界设计确保了 Theme 专注于视觉计算，而不会因为处理多媒体资源而引入副作用或复杂度。
配置依赖：Theme 模块唯一的外部依赖是其配置文件（theme.config）。在应用初始化时，模块会加载配置内容到内存中，后续函数调用都直接使用内存中的映射数据，无需反复读取磁盘或远程资源。因此在运行期，Theme 模块对配置的访问也是无副作用的。开发者在修改映射关系时，只需更新配置文件并重启/重新部署，所有映射变更即可生效，符合配置即代码的理念。
调用顺序示例
下面通过一个典型流程说明 Theme 模块的调用顺序和交互：
书籍主题获取：当用户打开书籍详情页时，前端或后端会调用 getBookTheme(book) 来获取该书籍的主题配置。
函数首先内部调用 getCoverColor(book.cover) 来确定封面颜色：如果 book 对象中存在用户自定义颜色则直接用之，否则尝试从 book.cover 的图像URL提取主色，若无封面则使用默认颜色。
接着调用 getStageVisual(book.maturityStage) 获取该书籍当前成熟度阶段对应的基础颜色和默认图标。比如返回 { color: "#2DA44E", icon: "award" } 表示稳定阶段默认绿色和奖章图标。
然后，根据书籍阶段和属性决定最终图标呈现：若阶段未达到稳定，则直接使用上一步的 Lucide 图标；若阶段是稳定且 book 对象包含了自定义图标的 URL（例如 book.customIcon），则优先选用该图像作为图标，并将返回对象的 icon 替换为此 URL，iconType 标记为 "image"。
综合以上信息，getBookTheme 组装返回一个完整的主题配置对象，包括：最终确定的颜色值、最终使用的图标（名称或URL）、以及图标类型标识。这个过程不依赖外部环境，所有决策基于输入的 book 数据和内部配置完成。
前端渲染应用：调用方（可能是前端代码）拿到 getBookTheme 返回的主题对象后，即可将其中的信息应用到界面：
将主题颜色应用为页面元素（如封面区域背景）的样式；
判断 iconType 来决定如何渲染图标：如果是 "lucide"，则使用 Lucide 图标组件或<img>标签引用对应的 SVG 符号来绘制图标；如果是 "image"，则创建<img>元素加载该自定义图标URL。
由于 Theme 模块已经在后端确定好了色值和图标来源，前端只需简单逻辑即可正确显示，不会出现阶段与颜色/图标不一致的情况。
时间线事件显示：在书籍的编年史时间线中，各事件节点通常会附带一个表示事件阶段的图标。例如，某事件发生在书籍的 growing 阶段，则其图标应为小树苗；若事件标志着书籍进入 stable 阶段且有官方图标，则应显示该图标。时间线渲染时，流程如下：
对于每个事件，取出其所对应的阶段标识，调用 getStageVisual(stage) 获取阶段颜色和默认图标。
如果该事件阶段是稳定，并且书籍有专属图标，可进一步使用该自定义图标URL替换 getStageVisual 返回的默认图标。这里可利用配置中的 customIconBasePath 等规则构造图标URL（例如 customIconBasePath + bookId + ".png"），或直接从事件/书籍数据中读取现成的URL。
最终将得到的图标（Lucide 名称或图像URL）和颜色用于时间线UI元素：设置图标的SVG或<img>，以及相应的背景色/高亮色。
由于所有阶段映射均由 Theme 模块提供，时间线上的颜色和图标风格将与书籍详情页面保持一致。代码层面，时间线模块只负责根据事件数据调用 Theme 接口并渲染，不需要硬编码任何阶段颜色或图标，减少维护成本。
通过以上设计与计划，Wordloom 的 Theme 模块将以模块清晰、职责单一的方式提供书籍主题的颜色和图标支持。在保证视觉一致性的同时，采用纯函数和集中配置提高了系统的可维护性和可预测性，为将来扩展（增加新阶段、新主题风格等）提供了便利的途径。每个部分的职责和边界明确：Theme 模块管逻辑和配置，Media 管存储，前端管呈现，各司其职又紧密配合。