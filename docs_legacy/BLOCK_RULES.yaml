# ============================================
# Wordloom v3 BLOCK_RULES
# ============================================
# 本文件只规范 Block 行为与命令层协议；
# 领域建模见 assets/docs/DDD_RULES.yaml；
# 端口/适配器见 assets/docs/HEXAGONAL_RULES.yaml；
# 视觉与布局见 assets/docs/VISUAL_RULES.yaml；
# 键盘矩阵细节见 assets/docs/BLOCK_KEYBOARD_RULES.yaml。

metadata:
  version: "0.1"
  last_reviewed: "2025-12-05"
  owners:
    - "BookEditor Guild"
  scope: "Block 行为规则 / 命令层协议 / 关键入口约束"
  references:
    - label: "DDD_RULES.POLICY-BLOCK-PLAN165A-BASE-PARAGRAPH"
      path: "assets/docs/DDD_RULES.yaml"
    - label: "HEXAGONAL_RULES.block_editor_plan165a_base_paragraph_guard"
      path: "assets/docs/HEXAGONAL_RULES.yaml"
    - label: "HEXAGONAL_RULES.block_editor_plan165c_transform_guard"
      path: "assets/docs/HEXAGONAL_RULES.yaml"
    - label: "VISUAL_RULES.block_editor_plan165a_base_paragraph_guard"
      path: "assets/docs/VISUAL_RULES.yaml"
    - label: "VISUAL_RULES.block_editor_plan165c_transform_contract"
      path: "assets/docs/VISUAL_RULES.yaml"
    - label: "BLOCK_KEYBOARD_RULES"
      path: "assets/docs/BLOCK_KEYBOARD_RULES.yaml"

# --------------------------------------------
# 不变式 / 红线
# --------------------------------------------
domain_contracts:
  base_paragraph_guard:
    summary: "任意 Book 文档必须至少保留一个 paragraph block"
    rules:
      - "删除/替换任意 block 后，命令层必须重新验证 paragraph 是否存在"
      - "UI 禁止通过直接 mutate store 的方式移除最后一个 paragraph"
  block_kind_roles:
    summary: "BlockKind 分层：paragraph = 基础块，其他 = 特殊块"
    base_kind: "paragraph"
    special_kinds:
      - "bulleted_list"
      - "numbered_list"
      - "todo_list"
      - "quote"
      - "callout"
      - "panel"
    notes:
      - "新增 BlockKind 时必须在 delete fallback 表中登记"
  domain_purity:
    summary: "Domain 模型不存 selection / spacing / caret 状态"
    rules:
      - "selectionStore 仅存在于 UI adapter"
      - "任何 spacing/vertical rhythm 诉求必须回到 VISUAL_RULES"
  soft_break_semantics:
    summary: "Shift+Enter 软换行只影响行内文本，不改变 Block 结构"
    rules:
      - "软换行在内容层使用 '\\n' 或等价 soft-break API 表示，同一 Block 内允许出现多行文本。"
      - "isEmpty / deleteGuard 判空时，文本仅包含空白字符（含空格、Tab、'\\n'）仍视为“空”，不得因为软换行改变退出语义。"
      - "列表/待办 family 中，软换行不得单独触发 block 级退出或 deleteBlockWithGuard，只能在当前 item 内换行。"

# --------------------------------------------
# 命令层协议（Plan165A/165C/166A）
# --------------------------------------------
command_layer:
  create_block:
    description: "BookEditor 凡是新增 block，一律通过 commands.createBlock + use case"
    preconditions:
      - "调用方必须提供目标插入位置及 fractional_index"
    effects:
      - "命令层会自动调用 ensureAtLeastOneBlock 保障基础段落"
      - "UI 不得直接 push 到 store"
  ensure_at_least_one_block:
    description: "进入文档或删除后若无 paragraph，则自动插入空 paragraph"
    behavior:
      - "仅在命令层触发；UI 不得手动补"
  transform_block_kind:
    version: "v1 - 空段落专用"
    description: "在原位把空 paragraph 换皮为特殊块"
    preconditions:
      - "source block.kind = paragraph"
      - "paragraph 内容为空（text='', 无 inline marks, 无 TODO items)"
      - "调用方已确认 caret 不在组合输入 (IME composing=false)"
    effects:
      - "block.kind 更新为目标特殊块"
      - "payload 重置为该特殊块的默认结构 (text='', items=[...], checked=false 等)"
      - "selectionStore 由命令层广播 caret intent，UI 不追加焦点处理"
    forbidden_usage:
      - "禁止在非空段落上调用（会吞文本）"
      - "禁止作为“插入 + 删除临时 paragraph”的补丁"
    allowed_targets:
      - "bulleted_list"
      - "numbered_list"
      - "todo_list"
      - "quote"
      - "callout"
      - "panel"
    future_work:
      - "若需支持“把段落文本变成 list 第一项”，需另建命令，不复用本 API"
  delete_block_with_guard:
    description: "所有删除入口唯一命令，负责降级与 caret 宣告"
    preconditions:
      - "UI 通过 onRequestDeleteBlock 提供 blockId 和上下文"
      - "禁止从命令内部再次调用 deleteBlockWithGuard（防递归）"
    effects:
      - "若文档仅剩当前 block，先降级/补 paragraph 再删除"
      - "特殊块优先降级为 paragraph（见 delete_fallbacks）"
      - "guard 会根据上下文发出 focus intent（上一个或下一个 block）"
    notes:
      - "UI 删除菜单/Backspace/CTA 删除等路径都必须走此命令"
  delete_block:
    description: "底层原子操作，仅供命令层内部调用"
    rules:
      - "UI 禁止触达"
      - "命令层需确保调用前后仍满足 base paragraph 守卫"
  delete_fallbacks:
    summary: "特殊块降级表"
    map:
      paragraph: null
      bulleted_list: paragraph
      numbered_list: paragraph
      todo_list: paragraph
      quote: paragraph
      callout: paragraph
      panel: paragraph

# --------------------------------------------
# UI / 命令映射（保持轻量）
# --------------------------------------------
ui_integration:
  slash_menu:
    must_call: "commands.transformBlockKind"
    preconditions:
      - "当前 block.kind = paragraph"
      - "paragraph 内容为空"
    forbidden:
      - "禁止先插入临时 paragraph 再删除"
  markdown_shortcuts:
    entrypoint: "ParagraphEditor.detectMarkdownShortcut"
    dispatch: "commands.transformBlockKind"
    minus_space:
      pattern: "'-' + Space"
      flow:
        - "确认 block.kind = paragraph 且文本除 pattern 外为空"
        - "清空当前段落文本"
        - "调用 transformBlockKind(paragraph -> bulleted_list)"
    star_space:
      pattern: "'*' + Space"
      flow:
        - "同 minus_space，只是目标 = bulleted_list"
    numbered_space:
      pattern: "'1.' + Space 或 '1) + Space'"
      flow:
        - "确认空段落 → transformBlockKind(paragraph -> numbered_list)"
    quote_space:
      pattern: "> + Space"
      flow:
        - "确认空段落 → transformBlockKind(paragraph -> quote)"
  toolbar_buttons:
    toggle_quote:
      must_call: "transformBlockKind"
      preconditions:
        - "当前 block 为空 paragraph"
        - "若段落非空，按钮需禁用或提示"
  deletion_paths:
    backspace_empty_block:
      must_call: "deleteBlockWithGuard"
      context:
        - "段落/列表/待办等在壳层判定为空"
    menu_delete:
      must_call: "deleteBlockWithGuard"
      context:
        - "BlockItem 菜单 -> 删除"
    tail_cta_delete:
      must_call: "deleteBlockWithGuard"
      notes:
        - "CTA（例如书尾“删除块”）必须沿用同一入口"
  delete_guard:
    entrypoint: "deleteBlockWithGuard"
    only_for:
      - "toolbar_delete"
      - "blockmenu_delete"
      - "backspace_on_empty_block"
    forbidden:
      - "markdown_shortcuts"
      - "list_row_backspace"
      - "todo_row_backspace"
    notes:
      - "list_row_backspace / todo_row_backspace = 列表家族内部行级退格，需由 Block 壳层自行处理行删/行插，不得直接调用 deleteBlockWithGuard"
      - "当 bulleted_list / numbered_list / todo_list 整块条目均为空且 keyboardDecider 判定 *-exit 时，Block 壳需改由 deleteBlockWithGuard（或其降级命令）删除该 block，并遵循 delete_fallbacks → paragraph 的总守卫"
  list_family_exit:
    summary: "Plan169B/170A：列表/待办退出只在 block 壳层发生，deleteGuard 只跑一次"
    rules:
      - "keyboardDecider 暴露 list_family_* 决策（insert/remove/exit），Block 壳收到 'exit' 时先标记 handled，再自行决定是否触发 deleteBlockWithGuard"
      - "壳层必须把 handled 状态传回 ParagraphEditor/BlockItem，防止 onSubmit/onDeleteEmptyBlock 再次触发 guard 造成双段落"
      - "当 allItemsEmpty=false 时，list/todo 行级 Enter/Backspace 只能创建/删除行，禁止触发 block 级 guard；只有 allItemsEmpty=true 才允许升级为 block 退出"
      - "双击/二次确认等 UX（pending exit flag）只存在于壳层内部，不得把“退出等待状态”写入 block content/Domain"
      - "壳层调用 deleteBlockWithGuard 时，必须遵守 delete_fallbacks → paragraph，避免手写 transformBlockKind 造成 caret intent 重复"
  inline_soft_break:
    entrypoint: "ParagraphEditor.onKeyDown / InlineEditor"
    behavior:
      - "Shift+Enter 必须在 onKeyDown 顶部拦截并处理后 return，不再透传到 keyboardDecider 或 block 级命令。"
      - "实现层通过 paragraphCommands.insertSoftBreak（或等价 inline 命令）仅更新当前文本与 caret offset，不调用 create_block / delete_block_with_guard / transform_block_kind。"

# --------------------------------------------
# 键盘组合到命令的映射（仅列关键项）
# --------------------------------------------
keyboard_mapping:
  slash:
    combo: ["/"]
    context: "空 paragraph 行首"
    command: "transformBlockKind（由 Slash 菜单项选择目标）"
  minus_space:
    combo: ["-", "Space"]
    context: "空 paragraph"
    command: "transformBlockKind(paragraph -> bulleted_list)"
  star_space:
    combo: ["*", "Space"]
    context: "空 paragraph"
    command: "transformBlockKind(paragraph -> bulleted_list)"
  numbered_space:
    combo: ["1.", "Space" / "1)", "Space"]
    context: "空 paragraph"
    command: "transformBlockKind(paragraph -> numbered_list)"
  quote_space:
    combo: [">", "Space"]
    context: "空 paragraph"
    command: "transformBlockKind(paragraph -> quote)"
  backspace_empty_block:
    combo: ["Backspace"]
    context: "Block shell 上报 empty"
    command: "deleteBlockWithGuard"
  soft_break_shift_enter:
    combo: ["Shift+Enter"]
    context: "Inline 编辑状态下的 paragraph / list-item / todo-item"
    command: "仅在当前 Block 文本中插入软换行（'\\n'），不创建/删除 Block，也不触发 list_family_exit 或 deleteBlockWithGuard。"

# --------------------------------------------
# 自查 / PR Checklist（保持 ≤10 条）
# --------------------------------------------
validation_checklist:
  - "新增或修改 Block 行为前，先阅读 metadata 中列出的四套 RULES 引用"
  - "任何创建/删除/变换 Block 的 UI 逻辑是否都调用 commands.* API？"
  - "是否存在直接调用 deleteBlock 或直接写入 block store 的代码？若有需改成 commands"
  - "所有 transform 调用是否都验证了“空 paragraph”前提？"
  - "删除路径是否全部走 deleteBlockWithGuard，并在 fallback 表里覆盖新 BlockKind？"
  - "Slash / Markdown / Toolbar 是否只在空 paragraph 暴露“变更 block 类型”入口？"
  - "delete_guard 是否仅由 toolbar/menu/backspace-on-empty-block 触发，且未被 markdown/内嵌编辑器触发？"
  - "列表/待办壳层是否只在 keyboardDecider 给出 list_family_exit 时才触发 deleteBlockWithGuard，并把 handled 标志传回 editor，防止 guard 跑两遍？"
  - "caret/focus 意图是否只由命令层（或 caret controller）发出，没有 UI 额外 setSelection？"
  - "是否更新/引用 BLOCK_RULES.yaml 让 Copilot 也能按规则生成代码？"
    - "列表家族（含 todo）双回车 / 空块退格退出时必须走 deleteBlockWithGuard（或 fallback 命令）并回退到 paragraph"
