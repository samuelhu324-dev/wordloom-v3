D:\Project\wordloom-v3\backend\scripts\legacy\search_outbox_worker.py:52: DeprecationWarning: 'asyncio.WindowsSelectorEventLoopPolicy' is deprecated and slated for removal in Python 3.16
  asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
D:\Project\wordloom-v3\backend\scripts\legacy\search_outbox_worker.py:52: DeprecationWarning: 'asyncio.set_event_loop_policy' is deprecated and slated for removal in Python 3.16
  asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
[OK] Database: postgresql+psycopg://wordloom:wordloom@localhost:5435/wordloom_test
{"ts": "2026-02-14T13:15:43.208337+00:00", "level": "INFO", "logger": "infra.observability.tracing", "event": "tracing.startup", "enabled": true, "otel_service_name": "wordloom-search-outbox-worker", "otlp_protocol": "http/protobuf", "otlp_target": "http://localhost:4318/v1/traces", "otlp_target_raw": "http://localhost:4318/v1/traces", "collector_reachable": true, "exporter_configured": true, "exporter_reason": "configured", "sampler": "always_on", "sampler_arg": "", "message": "tracing.startup", "taskName": null}
{"ts": "2026-02-14T13:15:43.209023+00:00", "level": "INFO", "logger": "infra.observability.tracing", "event": "tracing.config", "enabled": true, "otel_service_name": "wordloom-search-outbox-worker", "otlp_protocol": "http/protobuf", "otlp_target": "http://localhost:4318/v1/traces", "sampler": "always_on", "sampler_arg": "", "message": "tracing.config", "taskName": null}
{"ts": "2026-02-14T13:15:43.295456+00:00", "level": "INFO", "logger": "__main__", "message": "Search outbox worker starting: db=postgresql+psycopg://wordloom:wordloom@localhost:5435/wordloom_test, es=http://localhost:19200 index=wordloom-test-search-index, bulk=1, concurrency=1, poll=0.010s, worker_id=labs-expE-w2, lease=30s, max_processing=300s", "taskName": "Task-1"}
{"ts": "2026-02-14T13:15:43.295581+00:00", "level": "INFO", "logger": "__main__", "message": "Observability schema: labs-009-v2 (file=D:\\Project\\wordloom-v3\\backend\\scripts\\legacy\\search_outbox_worker.py)", "taskName": "Task-1"}
{"ts": "2026-02-14T13:15:43.295634+00:00", "level": "WARNING", "logger": "__main__", "message": "[LABS] OUTBOX_EXPERIMENT_BREAK_CLAIM enabled: claim is non-atomic (no row lock) with 1.500s delay", "taskName": "Task-1"}
{"ts": "2026-02-14T13:15:43.295771+00:00", "level": "WARNING", "logger": "__main__", "message": "[LABS] OUTBOX_EXPERIMENT_PROCESS_SLEEP_SECONDS enabled: sleeping 1.500s after claim before processing", "taskName": "Task-1"}
{"ts": "2026-02-14T13:15:43.300850+00:00", "level": "INFO", "logger": "__main__", "message": "Outbox worker metrics listening on :19131", "taskName": "Task-1"}
{"ts": "2026-02-14T13:15:43.423574+00:00", "level": "INFO", "logger": "__main__", "message": "Outbox runtime endpoints listening on :19151 (/healthz,/readyz)", "taskName": "Task-1"}
{"ts": "2026-02-14T13:15:43.454705+00:00", "level": "INFO", "logger": "__main__", "message": "[ENV_GUARD] Database environment check: OK", "taskName": "Task-1"}
{"ts": "2026-02-14T13:15:45.647376+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "5e1181d3-5025-450b-b4e8-378aad63ad53", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 1, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "9256530ad23e312443e1a0673366efb2", "span_id": "39c62c626ffbb124"}
{"ts": "2026-02-14T13:15:47.155607+00:00", "level": "WARNING", "logger": "__main__", "message": "[LABS] Skipped 1 outbox events due to owner mismatch (race / lost claim). Latest: id=daeac3e4-5393-4cbb-95de-31fed11298e5 owner=labs-expE-w1", "taskName": "Task-7", "trace_id": "0d0554b8e23bd9ea7f41bafbb0fcf687", "span_id": "f240e73158645925"}
{"ts": "2026-02-14T13:15:47.156821+00:00", "level": "INFO", "logger": "__main__", "event": "projection.process_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "5e1181d3-5025-450b-b4e8-378aad63ad53", "obs_schema": "labs-009-v2", "batch_size": 1, "entity_type": "book", "op": "upsert", "attempt": 0, "result": "ok", "reason": "owner_mismatch", "mode": "per_event", "message": "projection.process_batch", "taskName": "Task-1", "trace_id": "0d0554b8e23bd9ea7f41bafbb0fcf687", "span_id": "8056fd7a129dd2df"}
{"ts": "2026-02-14T13:15:47.175885+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "ca971e35-cd0d-45c5-b456-e9ff9245fdd0", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 0, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "402e7ab657868e80c28109eb39bbc9ae", "span_id": "12fa9de759026c74"}
{"ts": "2026-02-14T13:15:47.211504+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "5f00912e-e94e-4cb7-b21a-6d9c319fe462", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 0, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "bbda7a844461a4a16c8f230c4d2f6743", "span_id": "0e1f84a9f484d2cb"}
{"ts": "2026-02-14T13:15:47.247864+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "f5f26554-6f25-446a-89c3-67ed0046e107", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 0, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "0f1a2a33bff49ae603c6effb5c9ae8bb", "span_id": "0ff1a999849dc16b"}
{"ts": "2026-02-14T13:15:47.274126+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "237659c8-06ca-46de-8064-194afa2a0a95", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 0, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "08e225f668cc5d74b116d0a5d3ef5b80", "span_id": "a6794279f1c614a7"}
{"ts": "2026-02-14T13:15:47.306565+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "c3b2f1ba-dad4-4c8b-a1ca-4a1a8b7adabf", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 0, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "824c4f697dbcd5f8d70135e2a6e02fa7", "span_id": "8322440c4831003d"}
{"ts": "2026-02-14T13:15:47.341800+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "71f0ca2c-7555-45db-a182-a43a7d4f0484", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 0, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "da0e2146c3ff21d6b97aefe86630886a", "span_id": "573804711c05ebd0"}
{"ts": "2026-02-14T13:15:47.389772+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "3b980bc6-8728-4749-b09e-a4fe33a48b3f", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 0, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "3ab2b4dd5ea0af6a250af69a9713a4fd", "span_id": "36eafad53f3aead4"}
{"ts": "2026-02-14T13:15:47.436342+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "28b4b57a-cd7b-4869-8cee-fba9e3741f7d", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 0, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "66cd26b19b760b3904a2136ee8f79752", "span_id": "b77cbe619afdaddf"}
{"ts": "2026-02-14T13:15:47.483342+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "ad0801b3-b5d8-45c5-ab61-7f742e9964a3", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 0, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "1e9b5f76fc7f2d074d61cb8be423940b", "span_id": "4fc8edbe3fc825c7"}
{"ts": "2026-02-14T13:15:47.526825+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "4d1c95d6-5a1b-4f2c-80ce-58094b45ccc3", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 0, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "549c09b2d2c2d49b21789b8e7b36a77c", "span_id": "d10e01fdb68c29dc"}
{"ts": "2026-02-14T13:15:47.575083+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "8ba2e3f3-d6b9-4141-9892-4acddcd85992", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 0, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "5e99899ca75dde33fa4fd5d7dff025f6", "span_id": "b06b6d047129da98"}
{"ts": "2026-02-14T13:15:49.124169+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "c5d0bb64-f6a1-45ba-8d8a-83c7c6c2eb3d", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 1, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "0ae66babec5a0e494015154262b8900e", "span_id": "a446b012b6ace6d9"}
{"ts": "2026-02-14T13:15:50.636639+00:00", "level": "INFO", "logger": "__main__", "event": "projection.process_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "c5d0bb64-f6a1-45ba-8d8a-83c7c6c2eb3d", "obs_schema": "labs-009-v2", "batch_size": 1, "entity_type": "book", "op": "upsert", "attempt": 0, "result": "ok", "reason": "owner_mismatch", "mode": "per_event", "message": "projection.process_batch", "taskName": "Task-1", "trace_id": "d5b26a221ab7ef1b47baa6ad67764b40", "span_id": "7c040bcf38938469"}
{"ts": "2026-02-14T13:15:52.201934+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "e26fae2c-7181-4dd0-bc36-2e207ac84a6a", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 1, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "40b34a84b9518b719a4c01850d86539d", "span_id": "78a024914f10083c"}
{"ts": "2026-02-14T13:15:53.715050+00:00", "level": "WARNING", "logger": "__main__", "message": "[LABS] Skipped 3 outbox events due to owner mismatch (race / lost claim). Latest: id=5c780242-54a7-4ab6-bc62-a151d79854a4 owner=labs-expE-w1", "taskName": "Task-28", "trace_id": "0b794c9708ae9e3fb5d8e0e5243f7119", "span_id": "9bf56dfc1f9ead77"}
{"ts": "2026-02-14T13:15:53.717221+00:00", "level": "INFO", "logger": "__main__", "event": "projection.process_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "e26fae2c-7181-4dd0-bc36-2e207ac84a6a", "obs_schema": "labs-009-v2", "batch_size": 1, "entity_type": "book", "op": "upsert", "attempt": 0, "result": "ok", "reason": "owner_mismatch", "mode": "per_event", "message": "projection.process_batch", "taskName": "Task-1", "trace_id": "0b794c9708ae9e3fb5d8e0e5243f7119", "span_id": "930d912fa933685d"}
{"ts": "2026-02-14T13:15:55.245432+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "818dc9be-6a33-41eb-97a5-4c93e1198b3f", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 1, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "dd6dea06b3de74f2e5485d8241ab64a0", "span_id": "931db6f8a8f3cfeb"}
{"ts": "2026-02-14T13:15:56.754748+00:00", "level": "INFO", "logger": "__main__", "event": "projection.process_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "818dc9be-6a33-41eb-97a5-4c93e1198b3f", "obs_schema": "labs-009-v2", "batch_size": 1, "entity_type": "book", "op": "upsert", "attempt": 0, "result": "ok", "reason": "owner_mismatch", "mode": "per_event", "message": "projection.process_batch", "taskName": "Task-1", "trace_id": "987406ec822404431f87730e70240c36", "span_id": "13d5c53321da37c7"}
{"ts": "2026-02-14T13:15:58.300278+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "63b41f45-d086-40d8-af9d-fd4969a5e598", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 1, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "4a0919416af1c2901f2ad177f9300644", "span_id": "72f4e9cf6e658a08"}
{"ts": "2026-02-14T13:15:59.811346+00:00", "level": "WARNING", "logger": "__main__", "message": "[LABS] Skipped 5 outbox events due to owner mismatch (race / lost claim). Latest: id=2f590787-cb59-4601-ba0a-8a8d5db3b592 owner=labs-expE-w1", "taskName": "Task-38", "trace_id": "db654535b5644b6242094d4a317efc28", "span_id": "6195e500dbff39cc"}
{"ts": "2026-02-14T13:15:59.812141+00:00", "level": "INFO", "logger": "__main__", "event": "projection.process_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "63b41f45-d086-40d8-af9d-fd4969a5e598", "obs_schema": "labs-009-v2", "batch_size": 1, "entity_type": "book", "op": "upsert", "attempt": 0, "result": "ok", "reason": "owner_mismatch", "mode": "per_event", "message": "projection.process_batch", "taskName": "Task-1", "trace_id": "db654535b5644b6242094d4a317efc28", "span_id": "94236b94dbf7d427"}
{"ts": "2026-02-14T13:16:01.342384+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "87abef6f-b94b-4791-9c8c-c14b149f910a", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 1, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "6460d916c5d808ef0b18efbf682a30e3", "span_id": "a53bc017fdc6d484"}
{"ts": "2026-02-14T13:16:02.847881+00:00", "level": "INFO", "logger": "__main__", "event": "projection.process_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "87abef6f-b94b-4791-9c8c-c14b149f910a", "obs_schema": "labs-009-v2", "batch_size": 1, "entity_type": "book", "op": "upsert", "attempt": 0, "result": "ok", "reason": "owner_mismatch", "mode": "per_event", "message": "projection.process_batch", "taskName": "Task-1", "trace_id": "18563dddec14e72c5bef69d11459b55b", "span_id": "17aa9e185d70d9d5"}
{"ts": "2026-02-14T13:16:04.384813+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "26372269-2592-4e16-b15a-b7cfc5414ed7", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 1, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "ce953fef5a16271fe3a3c7ced71bc6f1", "span_id": "4009add27ca2ef41"}
{"ts": "2026-02-14T13:16:05.900506+00:00", "level": "WARNING", "logger": "__main__", "message": "[LABS] Skipped 7 outbox events due to owner mismatch (race / lost claim). Latest: id=570dab8a-7fc9-4530-87ac-1cac66f3d925 owner=labs-expE-w1", "taskName": "Task-48", "trace_id": "21b150ff6ce357559129ab685e756888", "span_id": "81ac40e33e9aad1d"}
{"ts": "2026-02-14T13:16:05.901484+00:00", "level": "INFO", "logger": "__main__", "event": "projection.process_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "26372269-2592-4e16-b15a-b7cfc5414ed7", "obs_schema": "labs-009-v2", "batch_size": 1, "entity_type": "book", "op": "upsert", "attempt": 0, "result": "ok", "reason": "owner_mismatch", "mode": "per_event", "message": "projection.process_batch", "taskName": "Task-1", "trace_id": "21b150ff6ce357559129ab685e756888", "span_id": "d0280c1746e55b79"}
{"ts": "2026-02-14T13:16:07.435175+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "bb1e14ff-d116-4f63-9efa-ef159057e969", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 1, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "5d541138c63b0aea3703be5933291e38", "span_id": "b7814f34822ccbe1"}
{"ts": "2026-02-14T13:16:08.947142+00:00", "level": "INFO", "logger": "__main__", "event": "projection.process_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "bb1e14ff-d116-4f63-9efa-ef159057e969", "obs_schema": "labs-009-v2", "batch_size": 1, "entity_type": "book", "op": "upsert", "attempt": 0, "result": "ok", "reason": "owner_mismatch", "mode": "per_event", "message": "projection.process_batch", "taskName": "Task-1", "trace_id": "b48477acfc1b45ef110803f6fc7b991d", "span_id": "e911eb42346dcc7e"}
{"ts": "2026-02-14T13:16:08.960446+00:00", "level": "WARNING", "logger": "__main__", "message": "Reclaimed 1 stuck outbox events (expired lease or max processing exceeded)", "taskName": "Task-1"}
{"ts": "2026-02-14T13:16:10.479741+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "labs-expE-w2", "claim_batch_id": "841dbb87-34b3-4b1f-a3cd-4c86c2b55025", "obs_schema": "labs-009-v2", "batch_size": 1, "claimed": 1, "claim_mode": "non_atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "0fa24b5739ae021cc8ca6c2d1e510de4", "span_id": "f6fa14a74d524125"}
