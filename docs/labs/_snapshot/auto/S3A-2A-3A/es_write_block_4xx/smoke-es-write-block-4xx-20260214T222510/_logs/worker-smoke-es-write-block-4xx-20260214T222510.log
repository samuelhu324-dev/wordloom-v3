D:\Project\wordloom-v3\backend\scripts\legacy\search_outbox_worker.py:52: DeprecationWarning: 'asyncio.WindowsSelectorEventLoopPolicy' is deprecated and slated for removal in Python 3.16
  asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
D:\Project\wordloom-v3\backend\scripts\legacy\search_outbox_worker.py:52: DeprecationWarning: 'asyncio.set_event_loop_policy' is deprecated and slated for removal in Python 3.16
  asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
[OK] Database: postgresql+psycopg://wordloom:wordloom@localhost:5435/wordloom_test
{"ts": "2026-02-14T14:25:13.941755+00:00", "level": "INFO", "logger": "infra.observability.tracing", "event": "tracing.startup", "enabled": true, "otel_service_name": "wordloom-search-outbox-worker", "otlp_protocol": "http/protobuf", "otlp_target": "http://localhost:4318/v1/traces", "otlp_target_raw": "http://localhost:4318/v1/traces", "collector_reachable": true, "exporter_configured": true, "exporter_reason": "configured", "sampler": "always_on", "sampler_arg": "", "message": "tracing.startup", "taskName": null}
{"ts": "2026-02-14T14:25:13.945710+00:00", "level": "INFO", "logger": "infra.observability.tracing", "event": "tracing.config", "enabled": true, "otel_service_name": "wordloom-search-outbox-worker", "otlp_protocol": "http/protobuf", "otlp_target": "http://localhost:4318/v1/traces", "sampler": "always_on", "sampler_arg": "", "message": "tracing.config", "taskName": null}
{"ts": "2026-02-14T14:25:13.995385+00:00", "level": "INFO", "logger": "__main__", "message": "Search outbox worker starting: db=postgresql+psycopg://wordloom:wordloom@localhost:5435/wordloom_test, es=http://localhost:19200 index=wordloom-test-search-index, bulk=100, concurrency=1, poll=1.000s, worker_id=DESKTOP-8ITAL7O:16012, lease=30s, max_processing=300s", "taskName": "Task-1"}
{"ts": "2026-02-14T14:25:13.995515+00:00", "level": "INFO", "logger": "__main__", "message": "Observability schema: labs-009-v2 (file=D:\\Project\\wordloom-v3\\backend\\scripts\\legacy\\search_outbox_worker.py)", "taskName": "Task-1"}
{"ts": "2026-02-14T14:25:13.999430+00:00", "level": "INFO", "logger": "__main__", "message": "Outbox worker metrics listening on :19143", "taskName": "Task-1"}
{"ts": "2026-02-14T14:25:14.084370+00:00", "level": "INFO", "logger": "__main__", "message": "Outbox runtime endpoints listening on :19145 (/healthz,/readyz)", "taskName": "Task-1"}
{"ts": "2026-02-14T14:25:14.108089+00:00", "level": "INFO", "logger": "__main__", "message": "[ENV_GUARD] Database environment check: OK", "taskName": "Task-1"}
{"ts": "2026-02-14T14:25:14.563889+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:16012", "claim_batch_id": "63fd3230-6244-4715-b2bb-b8a3dc5e5e7d", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "7a7a296b305a3fb84f46a65f18a717b7", "span_id": "cc448b95610c3418"}
{"ts": "2026-02-14T14:25:15.580704+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:16012", "claim_batch_id": "22711cb7-314d-4b6e-bb75-641b943a52c4", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "59db4ec83c9dafa560597c3a190a60bc", "span_id": "5045e4ed2eb914b7"}
{"ts": "2026-02-14T14:25:16.612103+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:16012", "claim_batch_id": "fd5bf771-830a-4742-bb54-02c552b9fe7d", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 1, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "54e5aed564d683fd0ac5bcc96863232c", "span_id": "b10682e340a99492"}
{"ts": "2026-02-14T14:25:16.903485+00:00", "level": "INFO", "logger": "httpx", "message": "HTTP Request: PUT http://localhost:19200/wordloom-test-search-index/_doc/book:9481edc2-e9ab-47ac-a3ed-44e88dd6a0cb \"HTTP/1.1 201 Created\"", "taskName": "Task-11", "trace_id": "4efe8ea56b7be584f85ed88c5388496e", "span_id": "955b4ce5378a5304"}
{"ts": "2026-02-14T14:25:16.905439+00:00", "level": "INFO", "logger": "__main__", "message": "Outbox upsert: indexed book 9481edc2-e9ab-47ac-a3ed-44e88dd6a0cb (version=0) into ES", "taskName": "Task-11", "trace_id": "4efe8ea56b7be584f85ed88c5388496e", "span_id": "955b4ce5378a5304"}
{"ts": "2026-02-14T14:25:16.910062+00:00", "level": "INFO", "logger": "__main__", "event": "projection.process_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:16012", "claim_batch_id": "fd5bf771-830a-4742-bb54-02c552b9fe7d", "obs_schema": "labs-009-v2", "batch_size": 1, "entity_type": "book", "op": "upsert", "attempt": 4, "result": "ok", "reason": "none", "mode": "per_event", "message": "projection.process_batch", "taskName": "Task-1", "trace_id": "4efe8ea56b7be584f85ed88c5388496e", "span_id": "c9c073cca0e47918"}
{"ts": "2026-02-14T14:25:16.919573+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:16012", "claim_batch_id": "11237745-c05c-4191-aecc-d9a17f0946ea", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "1334c35f966d264f510c14851d4cef17", "span_id": "e18b60906ec26919"}
{"ts": "2026-02-14T14:25:17.940001+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:16012", "claim_batch_id": "15b25ae0-394d-4d65-8d9b-3ff8bd79ed49", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "9f423e759401c4bca7d50b8ab495170d", "span_id": "c43098ec8dd200bf"}
{"ts": "2026-02-14T14:25:18.980754+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:16012", "claim_batch_id": "199e0240-44b6-4c99-9d5d-dbcfbc58807f", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "01030ffd0f435caec2f59233a56248bc", "span_id": "93d9ba193dd371c7"}
{"ts": "2026-02-14T14:25:20.007221+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:16012", "claim_batch_id": "76862079-3c7e-42be-ab41-7fed38ed6511", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 1, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "6942f18a098a116d6aa2aa1efd8709af", "span_id": "326b12139c3eb3f3"}
{"ts": "2026-02-14T14:25:20.018866+00:00", "level": "INFO", "logger": "httpx", "message": "HTTP Request: PUT http://localhost:19200/wordloom-test-search-index/_doc/book:107098d2-3cfb-49b8-9b92-0522efb5bd35 \"HTTP/1.1 403 Forbidden\"", "taskName": "Task-22", "trace_id": "21260a03aa5c870e38f71b426422ede8", "span_id": "52b67544ccecb954"}
{"ts": "2026-02-14T14:25:20.020417+00:00", "level": "ERROR", "logger": "__main__", "message": "Failed to process outbox event 4a091585-f2c8-4987-a145-ef02b85dcbf8", "taskName": "Task-22", "trace_id": "21260a03aa5c870e38f71b426422ede8", "span_id": "52b67544ccecb954", "exc_info": "Traceback (most recent call last):\n  File \"D:\\Project\\wordloom-v3\\backend\\scripts\\legacy\\search_outbox_worker.py\", line 918, in _process_one\n    await _process_upsert(session, client, es_index, ev)\n  File \"D:\\Project\\wordloom-v3\\backend\\scripts\\legacy\\search_outbox_worker.py\", line 371, in _process_upsert\n    resp.raise_for_status()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"D:\\Project\\wordloom-v3\\.venv\\Lib\\site-packages\\httpx\\_models.py\", line 829, in raise_for_status\n    raise HTTPStatusError(message, request=request, response=self)\nhttpx.HTTPStatusError: Client error '403 Forbidden' for url 'http://localhost:19200/wordloom-test-search-index/_doc/book:107098d2-3cfb-49b8-9b92-0522efb5bd35'\nFor more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/403"}
{"ts": "2026-02-14T14:25:20.026657+00:00", "level": "INFO", "logger": "__main__", "event": "projection.process_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:16012", "claim_batch_id": "76862079-3c7e-42be-ab41-7fed38ed6511", "obs_schema": "labs-009-v2", "batch_size": 1, "entity_type": "book", "op": "upsert", "attempt": 0, "result": "failed", "reason": "es_4xx", "mode": "per_event", "message": "projection.process_batch", "taskName": "Task-1", "trace_id": "21260a03aa5c870e38f71b426422ede8", "span_id": "4b8fa7cfbd9f9c02"}
{"ts": "2026-02-14T14:25:20.034062+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:16012", "claim_batch_id": "8b7ae0da-ef15-4112-9389-9bb6b4c37f03", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "8807b161d98e4ba3e713ae0fcc979f42", "span_id": "be503c1882830292"}
{"ts": "2026-02-14T14:25:21.046319+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:16012", "claim_batch_id": "8684a4af-e60d-4d54-97bc-ed0f8146f0a4", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "704db1246899ec07a0f18df4f72c104e", "span_id": "26e3857a5ac5e3fa"}
{"ts": "2026-02-14T14:25:22.062576+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:16012", "claim_batch_id": "334e9042-384c-442e-a168-b7e6a919c5df", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "ad2359c56bc8b8285a52e646201cfc89", "span_id": "9c0f89cf720b2e0d"}
{"ts": "2026-02-14T14:25:23.076426+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:16012", "claim_batch_id": "14e3c1a6-bd8f-4708-9c3d-a7d19bcb0931", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "87b1fb9117022f2e561477be21ee08ca", "span_id": "aefe79efba0da762"}
{"ts": "2026-02-14T14:25:24.097318+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:16012", "claim_batch_id": "7d29e3f0-4a7d-4d9f-b4e3-d63840035501", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "1cca365f5ea64ae21edf4b8329388011", "span_id": "f097e0aafda72d8f"}
{"ts": "2026-02-14T14:25:25.131343+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:16012", "claim_batch_id": "5b2351a7-5bda-4173-b8fe-2c0829bf9066", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "53b527cf1244c60945dd6b60710bce16", "span_id": "30a583ee1ebca3ca"}
{"ts": "2026-02-14T14:25:26.155405+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:16012", "claim_batch_id": "805510de-b99e-4a31-83a5-de8eeea5322e", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "df0cb35d5b425d3c03c36625409c2911", "span_id": "719ef64d6c3d62ae"}
{"ts": "2026-02-14T14:25:27.170742+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:16012", "claim_batch_id": "9d6cfccb-780b-456a-bc92-a55753e5f3ea", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "25fcdfe68eb113f3c7152825413c77a0", "span_id": "b23982d42db5ebfd"}
