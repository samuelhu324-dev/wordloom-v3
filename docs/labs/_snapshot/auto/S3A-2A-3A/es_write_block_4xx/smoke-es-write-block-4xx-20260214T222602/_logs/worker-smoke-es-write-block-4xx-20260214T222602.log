D:\Project\wordloom-v3\backend\scripts\legacy\search_outbox_worker.py:52: DeprecationWarning: 'asyncio.WindowsSelectorEventLoopPolicy' is deprecated and slated for removal in Python 3.16
  asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
D:\Project\wordloom-v3\backend\scripts\legacy\search_outbox_worker.py:52: DeprecationWarning: 'asyncio.set_event_loop_policy' is deprecated and slated for removal in Python 3.16
  asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
[OK] Database: postgresql+psycopg://wordloom:wordloom@localhost:5435/wordloom_test
{"ts": "2026-02-14T14:26:06.116467+00:00", "level": "INFO", "logger": "infra.observability.tracing", "event": "tracing.startup", "enabled": true, "otel_service_name": "wordloom-search-outbox-worker", "otlp_protocol": "http/protobuf", "otlp_target": "http://localhost:4318/v1/traces", "otlp_target_raw": "http://localhost:4318/v1/traces", "collector_reachable": true, "exporter_configured": true, "exporter_reason": "configured", "sampler": "always_on", "sampler_arg": "", "message": "tracing.startup", "taskName": null}
{"ts": "2026-02-14T14:26:06.117048+00:00", "level": "INFO", "logger": "infra.observability.tracing", "event": "tracing.config", "enabled": true, "otel_service_name": "wordloom-search-outbox-worker", "otlp_protocol": "http/protobuf", "otlp_target": "http://localhost:4318/v1/traces", "sampler": "always_on", "sampler_arg": "", "message": "tracing.config", "taskName": null}
{"ts": "2026-02-14T14:26:06.155452+00:00", "level": "INFO", "logger": "__main__", "message": "Search outbox worker starting: db=postgresql+psycopg://wordloom:wordloom@localhost:5435/wordloom_test, es=http://localhost:19200 index=wordloom-test-search-index, bulk=100, concurrency=1, poll=1.000s, worker_id=DESKTOP-8ITAL7O:8864, lease=30s, max_processing=300s", "taskName": "Task-1"}
{"ts": "2026-02-14T14:26:06.155636+00:00", "level": "INFO", "logger": "__main__", "message": "Observability schema: labs-009-v2 (file=D:\\Project\\wordloom-v3\\backend\\scripts\\legacy\\search_outbox_worker.py)", "taskName": "Task-1"}
{"ts": "2026-02-14T14:26:06.158805+00:00", "level": "INFO", "logger": "__main__", "message": "Outbox worker metrics listening on :19143", "taskName": "Task-1"}
{"ts": "2026-02-14T14:26:06.224596+00:00", "level": "INFO", "logger": "__main__", "message": "Outbox runtime endpoints listening on :19145 (/healthz,/readyz)", "taskName": "Task-1"}
{"ts": "2026-02-14T14:26:06.271919+00:00", "level": "INFO", "logger": "__main__", "message": "[ENV_GUARD] Database environment check: OK", "taskName": "Task-1"}
{"ts": "2026-02-14T14:26:06.735562+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:8864", "claim_batch_id": "0b7d64cd-1aa1-4e73-a99a-cffb3d8e48e7", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 1, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "ddd1f06eda111ac6a671d5bf4c4a8a3f", "span_id": "b432a5af810ad6e3"}
{"ts": "2026-02-14T14:26:07.025553+00:00", "level": "INFO", "logger": "httpx", "message": "HTTP Request: PUT http://localhost:19200/wordloom-test-search-index/_doc/book:d08be072-f1a7-44a2-9e4d-68b6fe09faa3 \"HTTP/1.1 201 Created\"", "taskName": "Task-7", "trace_id": "cb141b55c7942c666cb119e597f56491", "span_id": "83a8433bc74ddcc0"}
{"ts": "2026-02-14T14:26:07.028477+00:00", "level": "INFO", "logger": "__main__", "message": "Outbox upsert: indexed book d08be072-f1a7-44a2-9e4d-68b6fe09faa3 (version=0) into ES", "taskName": "Task-7", "trace_id": "cb141b55c7942c666cb119e597f56491", "span_id": "83a8433bc74ddcc0"}
{"ts": "2026-02-14T14:26:07.033567+00:00", "level": "INFO", "logger": "__main__", "event": "projection.process_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:8864", "claim_batch_id": "0b7d64cd-1aa1-4e73-a99a-cffb3d8e48e7", "obs_schema": "labs-009-v2", "batch_size": 1, "entity_type": "book", "op": "upsert", "attempt": 3, "result": "ok", "reason": "none", "mode": "per_event", "message": "projection.process_batch", "taskName": "Task-1", "trace_id": "cb141b55c7942c666cb119e597f56491", "span_id": "595b3f8bb54d9a2f"}
{"ts": "2026-02-14T14:26:07.045042+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:8864", "claim_batch_id": "f57a1d55-9292-4b75-8ecb-d60510919bc6", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "b2ce64cd731c057f7195a1f4459987f4", "span_id": "4fe9cb7ece2eb096"}
{"ts": "2026-02-14T14:26:08.054604+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:8864", "claim_batch_id": "450f9593-d23f-4cad-8f6d-3b493cc492af", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "d3d2b8d1fba3476763205c006c0ed04e", "span_id": "7894464423ce464a"}
{"ts": "2026-02-14T14:26:09.068695+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:8864", "claim_batch_id": "533ef2ef-ebc0-44ec-ab6d-3fcb90a4660b", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "16a78c43ae28aea983e4cbbafb94cb64", "span_id": "9ce292cce2ead3b3"}
{"ts": "2026-02-14T14:26:10.085072+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:8864", "claim_batch_id": "6ad82b19-d977-47ec-8188-416e65a515ba", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "4f913a4b15d0974c12fac9e17c6a1323", "span_id": "109fa20b0ac33cc4"}
{"ts": "2026-02-14T14:26:11.100381+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:8864", "claim_batch_id": "fd33eb21-212f-4cb9-80e9-fbb354e82829", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "02ac1218b18482b1403f98ee3db6e6b6", "span_id": "c32f7888dbc1359f"}
{"ts": "2026-02-14T14:26:12.126892+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:8864", "claim_batch_id": "37d43149-cfa1-406d-ba15-f1cd6c328c07", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 1, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "05ab10ea7339d17bd26ec062cabeb731", "span_id": "ae667dbe02aa7d90"}
{"ts": "2026-02-14T14:26:12.391785+00:00", "level": "INFO", "logger": "httpx", "message": "HTTP Request: PUT http://localhost:19200/wordloom-test-search-index/_doc/book:ec95371c-90bd-4ff8-9643-d6dd998676b6 \"HTTP/1.1 403 Forbidden\"", "taskName": "Task-22", "trace_id": "dc1312d390cebb4bef7584d2c33a3ba0", "span_id": "c182b9fc957c9cca"}
{"ts": "2026-02-14T14:26:12.393194+00:00", "level": "ERROR", "logger": "__main__", "message": "Failed to process outbox event f0938244-fb2a-4196-8fa4-42051e976a7a", "taskName": "Task-22", "trace_id": "dc1312d390cebb4bef7584d2c33a3ba0", "span_id": "c182b9fc957c9cca", "exc_info": "Traceback (most recent call last):\n  File \"D:\\Project\\wordloom-v3\\backend\\scripts\\legacy\\search_outbox_worker.py\", line 918, in _process_one\n    await _process_upsert(session, client, es_index, ev)\n  File \"D:\\Project\\wordloom-v3\\backend\\scripts\\legacy\\search_outbox_worker.py\", line 371, in _process_upsert\n    resp.raise_for_status()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"D:\\Project\\wordloom-v3\\.venv\\Lib\\site-packages\\httpx\\_models.py\", line 829, in raise_for_status\n    raise HTTPStatusError(message, request=request, response=self)\nhttpx.HTTPStatusError: Client error '403 Forbidden' for url 'http://localhost:19200/wordloom-test-search-index/_doc/book:ec95371c-90bd-4ff8-9643-d6dd998676b6'\nFor more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/403"}
{"ts": "2026-02-14T14:26:12.397850+00:00", "level": "INFO", "logger": "__main__", "event": "projection.process_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:8864", "claim_batch_id": "37d43149-cfa1-406d-ba15-f1cd6c328c07", "obs_schema": "labs-009-v2", "batch_size": 1, "entity_type": "book", "op": "upsert", "attempt": 0, "result": "failed", "reason": "es_4xx", "mode": "per_event", "message": "projection.process_batch", "taskName": "Task-1", "trace_id": "dc1312d390cebb4bef7584d2c33a3ba0", "span_id": "7da46121e480a0d0"}
{"ts": "2026-02-14T14:26:12.404836+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:8864", "claim_batch_id": "b5310db8-a696-4dee-bd73-45bef047266f", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "a3b3ede33a3bd557ef23c7dc8653ce35", "span_id": "08a8551b299daa0a"}
{"ts": "2026-02-14T14:26:13.416544+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:8864", "claim_batch_id": "a6dec296-3f19-4fb6-82d2-a25d857d8d9a", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "dcfc78a825a1f9749e1569b01a932f09", "span_id": "3e009aaa963d0042"}
{"ts": "2026-02-14T14:26:14.441284+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:8864", "claim_batch_id": "4add1ed9-2680-4841-8bba-1c280b8d9b5f", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "92273abcbb8f35a7bdb783753d0c4e02", "span_id": "a5739bd90d1a2631"}
{"ts": "2026-02-14T14:26:15.465077+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:8864", "claim_batch_id": "42efc808-ce8a-48e5-a49e-39364f03bb2e", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "d6f7f2e3f12d9344619ed6f2a8052c28", "span_id": "da64721eb4471d78"}
{"ts": "2026-02-14T14:26:16.488178+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:8864", "claim_batch_id": "044a745f-5c46-4628-b809-6a5e98a3393a", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "368f36e1f8fce491d1ea474750f61704", "span_id": "9eb2ef2b5920ab8a"}
{"ts": "2026-02-14T14:26:17.512829+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:8864", "claim_batch_id": "a35eb901-0e2a-4f10-816e-5f1f10597286", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "b1ac9cd04c0301bf5a6846f0173e75fa", "span_id": "7c6c159b27b7c771"}
{"ts": "2026-02-14T14:26:18.524371+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:8864", "claim_batch_id": "a948dbd0-d51a-47fd-97ce-b6a33bd13634", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "064ec6c0618870ffad99b9ccaa5cdd40", "span_id": "1d57def15e743a8e"}
