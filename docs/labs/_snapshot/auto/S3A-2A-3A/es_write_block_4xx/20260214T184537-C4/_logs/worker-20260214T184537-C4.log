D:\Project\wordloom-v3\backend\scripts\legacy\search_outbox_worker.py:52: DeprecationWarning: 'asyncio.WindowsSelectorEventLoopPolicy' is deprecated and slated for removal in Python 3.16
  asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
D:\Project\wordloom-v3\backend\scripts\legacy\search_outbox_worker.py:52: DeprecationWarning: 'asyncio.set_event_loop_policy' is deprecated and slated for removal in Python 3.16
  asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
[OK] Database: postgresql+psycopg://wordloom:wordloom@localhost:5435/wordloom_test
{"ts": "2026-02-14T10:47:00.035270+00:00", "level": "INFO", "logger": "infra.observability.tracing", "event": "tracing.startup", "enabled": true, "otel_service_name": "wordloom-search-outbox-worker", "otlp_protocol": "http/protobuf", "otlp_target": "http://localhost:4318/v1/traces", "otlp_target_raw": "http://localhost:4318/v1/traces", "collector_reachable": true, "exporter_configured": true, "exporter_reason": "configured", "sampler": "always_on", "sampler_arg": "", "message": "tracing.startup", "taskName": null}
{"ts": "2026-02-14T10:47:00.035636+00:00", "level": "INFO", "logger": "infra.observability.tracing", "event": "tracing.config", "enabled": true, "otel_service_name": "wordloom-search-outbox-worker", "otlp_protocol": "http/protobuf", "otlp_target": "http://localhost:4318/v1/traces", "sampler": "always_on", "sampler_arg": "", "message": "tracing.config", "taskName": null}
{"ts": "2026-02-14T10:47:00.105792+00:00", "level": "INFO", "logger": "__main__", "message": "Search outbox worker starting: db=postgresql+psycopg://wordloom:wordloom@localhost:5435/wordloom_test, es=http://localhost:19200 index=wordloom-test-search-index, bulk=100, concurrency=1, poll=1.000s, worker_id=DESKTOP-8ITAL7O:19096, lease=30s, max_processing=300s", "taskName": "Task-1"}
{"ts": "2026-02-14T10:47:00.105896+00:00", "level": "INFO", "logger": "__main__", "message": "Observability schema: labs-009-v2 (file=D:\\Project\\wordloom-v3\\backend\\scripts\\legacy\\search_outbox_worker.py)", "taskName": "Task-1"}
{"ts": "2026-02-14T10:47:00.110776+00:00", "level": "INFO", "logger": "__main__", "message": "Outbox worker metrics listening on :9120", "taskName": "Task-1"}
{"ts": "2026-02-14T10:47:00.196609+00:00", "level": "INFO", "logger": "__main__", "message": "Outbox runtime endpoints listening on :9122 (/healthz,/readyz)", "taskName": "Task-1"}
{"ts": "2026-02-14T10:47:00.221168+00:00", "level": "INFO", "logger": "__main__", "message": "[ENV_GUARD] Database environment check: OK", "taskName": "Task-1"}
{"ts": "2026-02-14T10:47:00.724361+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "83be0d6a-17f5-461f-a6b4-f9365e9d10fa", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "b3ad0b971d8c63c671e681030c1724ac", "span_id": "cb3402acd9245cdb"}
{"ts": "2026-02-14T10:47:01.742288+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "faff550c-6e52-4be2-830a-a8b4a607a920", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "b2bb2ed94a3f26496d0b86bc455a0c02", "span_id": "aa3f0f43ba3914fd"}
{"ts": "2026-02-14T10:47:02.763970+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "054a9cd9-99c4-422d-a338-37d022c9dc14", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "f90954d541f429884b911e1bae82b02d", "span_id": "770c7192fe7ffe59"}
{"ts": "2026-02-14T10:47:03.785306+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "8481f993-d129-480f-83b3-6a7de5297d19", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "af5fbd58f9ddfe566f4f322291926340", "span_id": "268749f43fce3f5c"}
{"ts": "2026-02-14T10:47:04.805741+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "595dc53c-7576-4056-a9b9-964f431a36c6", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "eb9869d62a3396a337b3704b99c1ba6a", "span_id": "4580717acf10f583"}
{"ts": "2026-02-14T10:47:05.837584+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "26cbfbb5-f570-4e94-b88d-4339bbcc03ce", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 1, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "e3412b36a024d5fbb7c780a615828787", "span_id": "58e33035f11e2844"}
{"ts": "2026-02-14T10:47:06.115712+00:00", "level": "INFO", "logger": "httpx", "message": "HTTP Request: PUT http://localhost:19200/wordloom-test-search-index/_doc/book:da08961f-7e8a-4292-a303-848997a0d77b \"HTTP/1.1 403 Forbidden\"", "taskName": "Task-19", "trace_id": "4e16e6baa5be64d1c53963a7f682c0f4", "span_id": "a2169c4e29e38f53"}
{"ts": "2026-02-14T10:47:06.117805+00:00", "level": "ERROR", "logger": "__main__", "message": "Failed to process outbox event 44555173-16b8-49d5-b9fa-201f7de3afd4", "taskName": "Task-19", "trace_id": "4e16e6baa5be64d1c53963a7f682c0f4", "span_id": "a2169c4e29e38f53", "exc_info": "Traceback (most recent call last):\n  File \"D:\\Project\\wordloom-v3\\backend\\scripts\\legacy\\search_outbox_worker.py\", line 918, in _process_one\n    await _process_upsert(session, client, es_index, ev)\n  File \"D:\\Project\\wordloom-v3\\backend\\scripts\\legacy\\search_outbox_worker.py\", line 371, in _process_upsert\n    resp.raise_for_status()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"D:\\Project\\wordloom-v3\\.venv\\Lib\\site-packages\\httpx\\_models.py\", line 829, in raise_for_status\n    raise HTTPStatusError(message, request=request, response=self)\nhttpx.HTTPStatusError: Client error '403 Forbidden' for url 'http://localhost:19200/wordloom-test-search-index/_doc/book:da08961f-7e8a-4292-a303-848997a0d77b'\nFor more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/403"}
{"ts": "2026-02-14T10:47:06.124068+00:00", "level": "INFO", "logger": "__main__", "event": "projection.process_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "26cbfbb5-f570-4e94-b88d-4339bbcc03ce", "obs_schema": "labs-009-v2", "batch_size": 1, "entity_type": "book", "op": "upsert", "attempt": 0, "result": "failed", "reason": "es_4xx", "mode": "per_event", "message": "projection.process_batch", "taskName": "Task-1", "trace_id": "4e16e6baa5be64d1c53963a7f682c0f4", "span_id": "df3e4cb2a53fde2f"}
{"ts": "2026-02-14T10:47:06.132330+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "0e699084-675c-434a-b4ee-c3eea73f2f1a", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "81be6c98446c9bb61e54505ddc48b85c", "span_id": "439c269b140c74d1"}
{"ts": "2026-02-14T10:47:07.150510+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "00a2c145-f377-4c02-88c1-4e857bdc0f86", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "b37bc7e27ed1c5888e822de98e4f1557", "span_id": "6950cecfbdddeb49"}
{"ts": "2026-02-14T10:47:08.169898+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "917b53f3-36eb-484d-9a83-5a7f29c935d5", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "e40b76d55becbb507a33884140e08616", "span_id": "a92cdef8a59e5f4a"}
{"ts": "2026-02-14T10:47:09.193750+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "8cdec376-7d8d-431e-b0ce-da6e26f938d4", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "61123401856532f521fec6e008d9a02b", "span_id": "0bdae066da05ae41"}
{"ts": "2026-02-14T10:47:10.211708+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "605ac4cd-af2a-44d7-a224-c509f19fda2d", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "145db9e5f9967baa5fe69b912a0c0f36", "span_id": "32ce6692d4b508be"}
{"ts": "2026-02-14T10:47:11.249599+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "13daab93-db1b-483a-bb46-2030679350b1", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "fdec74741a079dbb55238960eed87377", "span_id": "e446206e2b771a66"}
{"ts": "2026-02-14T10:47:12.273001+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "20a8731e-d4dc-4c88-93f8-6fb5df834e46", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "fc705184fd9a5d3f5296d7e55d9a6ac6", "span_id": "2429915951672c82"}
{"ts": "2026-02-14T10:47:13.301387+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "45129c69-7d9b-45bc-b094-f1cb86a38244", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "4070b564757f50b67ac5eb4394e4a26f", "span_id": "889901664d5b9ff4"}
{"ts": "2026-02-14T10:47:14.323050+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "8a899407-73a1-4a1d-985c-773f2d64cf7c", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "4bb6c05cbc50b751cdbd9b5b3ab1d985", "span_id": "a1583ebe674fab40"}
{"ts": "2026-02-14T10:47:15.345608+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "80ad4081-6a21-4fb7-97c3-5f6024221a42", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "34f8b5cb665237c2dd2b090eac3a2b5d", "span_id": "1e8bd0b71db32df9"}
{"ts": "2026-02-14T10:47:16.373244+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "6cf213fb-4a37-45f0-9996-81893fd2c5cb", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "e1f296b7daa787876a8883a76bb9c432", "span_id": "f27316ce3684572d"}
{"ts": "2026-02-14T10:47:17.386968+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "cd2a7051-14ed-44fb-b3f8-eda67562f3d6", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "56c5667fab2dfa0f31a488cd51dc7ae2", "span_id": "dbdbd20ee5c5430e"}
{"ts": "2026-02-14T10:47:18.407330+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "e7db07a7-742e-48e2-bc52-364fabdf300f", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "70227bb6f46daf87a2ee27348183c79c", "span_id": "ca739f58de872ef7"}
{"ts": "2026-02-14T10:47:19.430465+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "2040072e-f374-4db5-b5d0-16ea70044642", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "b22e2ea6c50fa75e68f72b1c0ef645de", "span_id": "7a460fbe1dda9965"}
{"ts": "2026-02-14T10:47:20.447788+00:00", "level": "INFO", "logger": "__main__", "event": "outbox.claim_batch", "layer": "worker", "projection": "search_index_to_elastic", "worker_id": "DESKTOP-8ITAL7O:19096", "claim_batch_id": "369bda02-9c19-41e7-8c5b-13df25950415", "obs_schema": "labs-009-v2", "batch_size": 100, "claimed": 0, "claim_mode": "atomic", "message": "outbox.claim_batch", "taskName": "Task-1", "trace_id": "c512d5b8ba943f9814359b37a22f8a2c", "span_id": "fe74655b87eb9a21"}
