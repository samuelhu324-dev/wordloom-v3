# Note å¤åˆ¶åŠŸèƒ½å®ç°æ€»ç»“

**å®Œæˆæ—¥æœŸ**: 2025-10-31
**åŠŸèƒ½**: ä¸º Orbit Notes æ·»åŠ å®Œæ•´çš„å¤åˆ¶ï¼ˆDuplicateï¼‰åŠŸèƒ½

---

## ğŸ“‹ åŠŸèƒ½è®¾è®¡

### å¤åˆ¶æµç¨‹
1. **æŸ¥è¯¢åŸ Note** â€” éªŒè¯ Note å­˜åœ¨
2. **åˆ›å»ºæ–° Note è®°å½•** â€” æ–° IDã€æ–°æ—¶é—´æˆ³ã€é‡ç½®ä½¿ç”¨æ¬¡æ•°
3. **å¤åˆ¶æ ‡ç­¾å…³è”** â€” ä¿æŒåŸæœ‰çš„æ‰€æœ‰æ ‡ç­¾
4. **å¤åˆ¶ä¸Šä¼ æ–‡ä»¶** â€” å®Œæ•´å¤åˆ¶ uploads æ–‡ä»¶å¤¹
5. **é”™è¯¯å›æ»š** â€” æ–‡ä»¶å¤åˆ¶å¤±è´¥æ—¶å›æ»šæ•°æ®åº“

### è®¾è®¡åŸåˆ™ï¼ˆå®Œå…¨éš”ç¦»æ–¹æ¡ˆï¼‰
- âœ… æ–° Note æœ‰ç‹¬ç«‹çš„ ID
- âœ… æ‰€æœ‰æ–‡ä»¶ç‰©ç†å¤åˆ¶ï¼ˆé¿å…ä¾èµ–å…³ç³»ï¼‰
- âœ… ä½¿ç”¨æ¬¡æ•°é‡ç½®ä¸º 0
- âœ… ä¿æŒåŸæ ‡ç­¾å’Œå…¶ä»–å…ƒæ•°æ®
- âœ… æ–°æ ‡é¢˜ä¸º `åŸæ ‡é¢˜ (å‰¯æœ¬)`

---

## ğŸ”§ æŠ€æœ¯å®ç°

### åç«¯æ–‡ä»¶

#### 1. `WordloomBackend/api/app/services/file_service.py` (æ–°å»º)
- `copy_directory()` â€” é€’å½’å¤åˆ¶æ–‡ä»¶å¤¹
- `copy_file()` â€” å¤åˆ¶å•ä¸ªæ–‡ä»¶
- `delete_directory()` â€” åˆ é™¤æ–‡ä»¶å¤¹
- `path_exists()` â€” æ£€æŸ¥è·¯å¾„å­˜åœ¨æ€§
- `ensure_directory()` â€” åˆ›å»ºç›®å½•ï¼ˆå¦‚ä¸å­˜åœ¨ï¼‰

**å…³é”®ç‰¹æ€§**: å¼‚å¸¸å¤„ç†ã€è·¯å¾„éªŒè¯

#### 2. `WordloomBackend/api/app/services/note_service.py` (æ–°å»º)
- `NoteService` ç±» â€” ç»Ÿä¸€çš„ Note ä¸šåŠ¡é€»è¾‘
- `duplicate_note()` â€” æ ¸å¿ƒå¤åˆ¶é€»è¾‘
  - æŸ¥è¯¢åŸ Note
  - åˆ›å»ºæ–° Noteï¼ˆæ•°æ®åº“ï¼‰
  - å¤åˆ¶æ ‡ç­¾å…³è”
  - å¤åˆ¶æ–‡ä»¶å¤¹
  - å¼‚å¸¸æ—¶è‡ªåŠ¨å›æ»š

#### 3. `WordloomBackend/api/app/routers/orbit/notes.py` (ä¿®æ”¹)

**æ·»åŠ  Schema**:
```python
class DuplicateNoteRequest(BaseModel):
    title_suffix: str = "(å‰¯æœ¬)"
```

**æ·»åŠ ç«¯ç‚¹**:
```
POST /orbit/notes/{note_id}/duplicate
è¯·æ±‚ä½“: { "title_suffix": "(å‰¯æœ¬)" }
å“åº”: NoteOut (æ–°åˆ›å»ºçš„ Note)
é”™è¯¯å¤„ç†:
  - 404: Note ä¸å­˜åœ¨
  - 500: æ–‡ä»¶å¤åˆ¶å¤±è´¥
```

### å‰ç«¯æ–‡ä»¶

#### 1. `WordloomFrontend/next/src/modules/orbit/domain/api.ts` (ä¿®æ”¹)
- æ·»åŠ  `duplicateNote()` å‡½æ•°
  - è°ƒç”¨ `POST /orbit/notes/{id}/duplicate`
  - ä¼ å…¥ `title_suffix` å‚æ•°
  - è¿”å›æ–° Note å¯¹è±¡

```typescript
export async function duplicateNote(id: string, titleSuffix: string = "(å‰¯æœ¬)"): Promise<Note>
```

#### 2. `WordloomFrontend/next/app/orbit/page.tsx` (ä¿®æ”¹)
- å¯¼å…¥ `duplicateNote` API
- æ·»åŠ  `duplicating` çŠ¶æ€è·Ÿè¸ª
- æ·»åŠ  `onDuplicate()` å¤„ç†å‡½æ•°
- UI æ·»åŠ å¤åˆ¶æŒ‰é’®ï¼ˆğŸ“‹ ç¬¦å·ï¼‰

**æŒ‰é’®ä½ç½®**:
- ç½‘æ ¼è§†å›¾ï¼šå¡ç‰‡å³ä¸Šè§’ï¼ŒHover æ˜¾ç¤º
- åˆ—è¡¨è§†å›¾ï¼šå³ä¾§æ“ä½œæ ï¼ŒHover æ˜¾ç¤º

**äº¤äº’æµç¨‹**:
1. ç”¨æˆ·ç‚¹å‡»å¤åˆ¶æŒ‰é’® (ğŸ“‹)
2. åç«¯åˆ›å»ºæ–° Note + å¤åˆ¶æ–‡ä»¶
3. å‰ç«¯åˆ·æ–° Note åˆ—è¡¨
4. æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆæ–° Note IDï¼‰

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
WordloomBackend/api/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ mermaid_service.py
â”‚   â”‚   â”œâ”€â”€ file_service.py         â† æ–°å»º
â”‚   â”‚   â””â”€â”€ note_service.py         â† æ–°å»º
â”‚   â””â”€â”€ routers/
â”‚       â””â”€â”€ orbit/
â”‚           â””â”€â”€ notes.py             â† ä¿®æ”¹: æ·»åŠ  duplicate ç«¯ç‚¹

WordloomFrontend/next/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ modules/
â”‚       â””â”€â”€ orbit/
â”‚           â””â”€â”€ domain/
â”‚               â””â”€â”€ api.ts           â† ä¿®æ”¹: æ·»åŠ  duplicateNote()
â””â”€â”€ app/
    â””â”€â”€ orbit/
        â””â”€â”€ page.tsx                 â† ä¿®æ”¹: æ·»åŠ  UI å’Œé€»è¾‘
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åç«¯æµ‹è¯•
```bash
# åˆ›å»ºæµ‹è¯• Note
POST /orbit/notes
{ "title": "Test Note", "content_md": "Content", "tags": ["tag1"] }

# å¤åˆ¶ Note
POST /orbit/notes/{note_id}/duplicate
{ "title_suffix": "(å‰¯æœ¬)" }

# éªŒè¯
- æ–° Note æœ‰ä¸åŒçš„ ID âœ“
- æ–° Note çš„ usage_count = 0 âœ“
- æ–° Note æœ‰ç›¸åŒçš„æ ‡ç­¾ âœ“
- uploads æ–‡ä»¶å¤¹è¢«å¤åˆ¶ âœ“
```

### å‰ç«¯æµ‹è¯•
1. è®¿é—® `/orbit` é¡µé¢
2. Hover åœ¨ Note å¡ç‰‡ä¸Š
3. ç‚¹å‡» ğŸ“‹ æŒ‰é’®ï¼ˆæ–°å¢çš„å¤åˆ¶æŒ‰é’®ï¼‰
4. ç¡®è®¤æˆåŠŸæç¤ºå‡ºç°
5. åˆ·æ–°åçœ‹åˆ°æ–° Note

---

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆå·²å®ç°ï¼‰
- âœ… åŸºç¡€å¤åˆ¶åŠŸèƒ½
- âœ… æ–‡ä»¶å®Œå…¨éš”ç¦»
- âœ… é”™è¯¯å¤„ç†å’Œå›æ»š
- âœ… å‰ç«¯ UI é›†æˆ

### ä¸­æœŸï¼ˆå¯è€ƒè™‘ï¼‰
- å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼ˆCeleryï¼‰â€” å¤§æ–‡ä»¶å¤åˆ¶æ—¶æ˜¾ç¤ºè¿›åº¦
- æ‰¹é‡å¤åˆ¶ â€” é€‰å¤šä¸ª Note ä¸€é”®å¤åˆ¶
- å¤åˆ¶é€‰é¡¹å¯¹è¯æ¡† â€” é€‰æ‹©ä¿ç•™/ä¿®æ”¹çš„å†…å®¹

### é•¿æœŸï¼ˆäº§å“çº§ï¼‰
- å¤åˆ¶å†å²å’Œç‰ˆæœ¬ç®¡ç†
- å·®å¼‚å¯¹æ¯”
- å®šæ—¶è‡ªåŠ¨å¤‡ä»½

---

## ğŸ“ API æ–‡æ¡£

### Duplicate Note ç«¯ç‚¹

**è¯·æ±‚**
```
POST /orbit/notes/{note_id}/duplicate
Content-Type: application/json

{
  "title_suffix": "(å‰¯æœ¬)"
}
```

**å“åº” (200 OK)**
```json
{
  "id": "new-uuid",
  "title": "Original Title (å‰¯æœ¬)",
  "content_md": "Content...",
  "status": "open",
  "priority": 3,
  "urgency": 3,
  "usage_level": 3,
  "usage_count": 0,
  "tags": ["tag1", "tag2"],
  "tags_rel": [
    {
      "id": "tag-uuid",
      "name": "tag1",
      "color": "#3B82F6",
      "icon": null,
      "description": null,
      "count": 1
    }
  ],
  "due_at": null,
  "created_at": "2025-10-31T12:34:56.789Z",
  "updated_at": "2025-10-31T12:34:56.789Z"
}
```

**é”™è¯¯å“åº”**
```json
// 404 Not Found
{ "detail": "note not found" }

// 500 Internal Server Error
{ "detail": "Failed to duplicate note: {error message}" }
```

---

## ğŸ” æ³¨æ„äº‹é¡¹

1. **æƒé™æ£€æŸ¥** â€” åæœŸå¯æ·»åŠ æƒé™éªŒè¯ï¼ˆç›®å‰æœªå®ç°ï¼‰
2. **å¹¶å‘å®‰å…¨** â€” SQLAlchemy è‡ªåŠ¨å¤„ç†ï¼Œæ— é¢å¤–éœ€æ±‚
3. **å­˜å‚¨ç©ºé—´** â€” å¤åˆ¶ä¼šç¿»å€å ç”¨ç©ºé—´ï¼Œå¤§æ–‡ä»¶æ—¶éœ€æç¤ºç”¨æˆ·
4. **äº‹åŠ¡ä¸€è‡´æ€§** â€” æ–‡ä»¶å¤åˆ¶å¤±è´¥æ—¶è‡ªåŠ¨å›æ»šæ•°æ®åº“

---

## ğŸ“š ç›¸å…³æ–‡ä»¶å˜æ›´

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `file_service.py` | æ–°å»º | æ–‡ä»¶æ“ä½œå·¥å…·ç±» |
| `note_service.py` | æ–°å»º | Note ä¸šåŠ¡é€»è¾‘ |
| `notes.py` (router) | ä¿®æ”¹ | æ·»åŠ  duplicate ç«¯ç‚¹ |
| `api.ts` | ä¿®æ”¹ | æ·»åŠ å‰ç«¯ API è°ƒç”¨ |
| `page.tsx` | ä¿®æ”¹ | æ·»åŠ  UI å’Œäº¤äº’ |

**æ€»è®¡**: 3 ä¸ªæ–°æ–‡ä»¶, 3 ä¸ªä¿®æ”¹çš„æ–‡ä»¶
