"use client";

import { useState, useMemo } from "react";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import { useRouter } from "next/navigation";
import { listNotes, createNote, deleteNote, incrementNoteUsage, duplicateNote, listBookshelves } from "@/modules/orbit/domain/api";
import { extractFirstImageFromHtml, extractFirstSentenceFromHtml } from "@/lib/imageUtils";
import type { Note } from "@/modules/orbit/domain/notes";
import type { Bookshelf } from "@/modules/orbit/domain/bookshelves";
import {
  Zap, Bug, TrendingUp, Clock, CheckCircle2,
  BookOpen, Link2, FileText, Code2, Lightbulb,
  AlertTriangle, Star, Smile, Pause, Flame,
  Palette, CheckCircle, Lock, Compass,
  Grid3x3, List, Plus, Trash2, Copy
} from "lucide-react";

type ViewMode = "grid" | "list";
type TabMode = "free-notes" | "bookshelves";

const ICON_COMPONENTS: Record<string, any> = {
  Zap, Bug, TrendingUp, Clock, CheckCircle2,
  BookOpen, Link2, FileText, Code2, Lightbulb,
  AlertTriangle, Star, Smile, Pause, Flame,
  Palette, CheckCircle, Lock, Compass,
};

function renderIcon(name?: string | null, color: string = "#111827", size = 16) {
  if (!name) return null;
  const C = ICON_COMPONENTS[name];
  if (!C) return null;
  return <C size={size} color={color} strokeWidth={2} />;
}

function contrastColor(hex: string): string {
  const h = hex.replace('#','');
  const r = parseInt(h.substring(0,2),16);
  const g = parseInt(h.substring(2,4),16);
  const b = parseInt(h.substring(4,6),16);
  const brightness = (r*299+g*587+b*114)/1000;
  return brightness > 128 ? '#111827' : '#FFFFFF';
}

export default function OrbitPage() {
  const router = useRouter();
  const qc = useQueryClient();
  const [tab, setTab] = useState<TabMode>("free-notes");
  const [q, setQ] = useState("");
  const [searchQ, setSearchQ] = useState("");
  const [tagInput, setTagInput] = useState("");
  const [tag, setTag] = useState("");
  const [status, setStatus] = useState("");
  const [sort, setSort] = useState("-updated_at");
  const [priority, setPriority] = useState("");
  const [urgency, setUrgency] = useState("");
  const [usageCount, setUsageCount] = useState("");
  const [viewMode, setViewMode] = useState<ViewMode>("grid");
  const [creating, setCreating] = useState(false);
  const [deleting, setDeleting] = useState<string | null>(null);
  const [showTagDropdown, setShowTagDropdown] = useState(false);
  const [duplicating, setDuplicating] = useState<string | null>(null);

  // è·å–æ‰€æœ‰ Notes
  const { data: notes = [], isLoading: notesLoading } = useQuery({
    queryKey: ["orbit", "notes", { q: searchQ, tag, status, sort }],
    queryFn: () => listNotes({ q: searchQ, tag, status, sort, limit: 100, offset: 0 }),
    staleTime: 15_000,
  });

  // è·å–æ‰€æœ‰ Bookshelves
  const { data: bookshelves = [], isLoading: bookselvesLoading } = useQuery({
    queryKey: ["orbit", "bookshelves"],
    queryFn: () => listBookshelves({ status: "active", limit: 100 }),
    staleTime: 15_000,
  });

  const isLoading = notesLoading || bookselvesLoading;

  // è¿‡æ»¤å‡ºè‡ªç”± Notesï¼ˆæ²¡æœ‰ bookshelf_id çš„ï¼‰
  const freeNotes = useMemo(() => {
    return notes.filter(n => !n.bookshelfId);
  }, [notes]);

  const tags = useMemo(() => Array.from(new Set(freeNotes.flatMap(n => n.tags))), [freeNotes]);

  // æŒ‰å­—æ¯æ’åºæ ‡ç­¾ï¼Œå¹¶æ ¹æ®è¾“å…¥è¿‡æ»¤
  const sortedTags = useMemo(() => {
    const sorted = [...tags].sort();
    if (!tagInput) return sorted.slice(0, 10);
    return sorted.filter(t => t.toLowerCase().includes(tagInput.toLowerCase()));
  }, [tags, tagInput]);

  // å‰ç«¯è¿‡æ»¤é€»è¾‘
  const filteredNotes = useMemo(() => {
    return freeNotes.filter(note => {
      if (priority && note.priority !== parseInt(priority)) return false;
      if (urgency && note.urgency !== parseInt(urgency)) return false;
      if (usageCount && note.usageCount !== parseInt(usageCount)) return false;
      return true;
    });
  }, [freeNotes, priority, urgency, usageCount]);

  async function onQuickCreate() {
    setCreating(true);
    try {
      const n = await createNote({ title: "Untitled", text: "" });
      await qc.invalidateQueries({ queryKey: ["orbit", "notes"] });
      router.push(`/orbit/${n.id}`);
    } finally {
      setCreating(false);
    }
  }

  async function onDelete(noteId: string, e: React.MouseEvent) {
    e.stopPropagation();
    if (!confirm("ç¡®å®šåˆ é™¤è¿™ä¸ª Note å—ï¼Ÿ")) return;

    setDeleting(noteId);
    try {
      await deleteNote(noteId);
      await qc.invalidateQueries({ queryKey: ["orbit", "notes"] });
    } finally {
      setDeleting(null);
    }
  }

  async function onDuplicate(noteId: string, e: React.MouseEvent) {
    e.stopPropagation();
    setDuplicating(noteId);
    try {
      const newNote = await duplicateNote(noteId);
      await qc.invalidateQueries({ queryKey: ["orbit", "notes"] });
      alert(`å·²å¤åˆ¶! æ–° Note ID: ${newNote.id}`);
    } catch (err) {
      console.error("å¤åˆ¶å¤±è´¥:", err);
      alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•");
    } finally {
      setDuplicating(null);
    }
  }

  async function onNoteClick(noteId: string) {
    try {
      await incrementNoteUsage(noteId);
      await qc.invalidateQueries({ queryKey: ["orbit", "notes"] });
    } catch (e) {
      console.error("Failed to increment usage:", e);
    }
    router.push(`/orbit/${noteId}`);
  }

  if (isLoading) return <main className="max-w-6xl mx-auto px-5 py-6">åŠ è½½ä¸­â€¦</main>;

  return (
    <main className="w-full min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
      {/* ç²˜æ€§ Tab æ  */}
      <div className="sticky top-0 z-40 bg-white border-b border-slate-200 shadow-sm">
        <div className="max-w-6xl mx-auto px-5 py-0">
          <div className="flex gap-0">
            {/* Free Notes Tab */}
            <button
              onClick={() => setTab("free-notes")}
              className={`px-6 py-4 font-semibold text-base border-b-2 transition flex items-center gap-2 ${
                tab === "free-notes"
                  ? "text-blue-600 border-blue-600 bg-blue-50"
                  : "text-slate-600 border-transparent hover:text-slate-900 hover:bg-slate-50"
              }`}
            >
              ğŸ”– Free Notes
            </button>

            {/* My Bookshelves Tab */}
            <button
              onClick={() => setTab("bookshelves")}
              className={`px-6 py-4 font-semibold text-base border-b-2 transition flex items-center gap-2 ${
                tab === "bookshelves"
                  ? "text-blue-600 border-blue-600 bg-blue-50"
                  : "text-slate-600 border-transparent hover:text-slate-900 hover:bg-slate-50"
              }`}
            >
              ğŸ“š My Bookshelves
            </button>
          </div>
        </div>
      </div>

      {/* å†…å®¹åŒºåŸŸ */}
      <div className="max-w-6xl mx-auto px-5 py-6">
        {tab === "free-notes" ? (
          // ========== FREE NOTES TAB ==========
          <>
            {/* æ ‡é¢˜éƒ¨åˆ† */}
            <div className="mb-8">
              <h1 className="text-4xl font-bold mb-2">è‡ªç”±ä¹¦ç­¾</h1>
              <p className="text-slate-600">æœªåˆ†ç±»çš„ç¬”è®° â€¢ {freeNotes.length} æ¡</p>
            </div>

            {/* æœç´¢å’Œè¿‡æ»¤ */}
            <div className="flex gap-4 mb-6 flex-wrap items-center justify-between">
              <div className="flex gap-4 flex-wrap items-center flex-1">
                <input
                  type="text"
                  placeholder="å…³é”®è¯ (Enter æœç´¢)"
                  value={q}
                  onChange={(e) => setQ(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === "Enter") {
                      setSearchQ(q);
                    }
                  }}
                  className="flex-1 min-w-48 rounded border p-2 text-sm"
                />
                <div className="relative">
                  <input
                    type="text"
                    placeholder="æ ‡ç­¾ (Enter é€‰æ‹©)"
                    value={tagInput}
                    onChange={(e) => setTagInput(e.target.value)}
                    onFocus={() => setShowTagDropdown(true)}
                    onBlur={() => setTimeout(() => setShowTagDropdown(false), 200)}
                    onKeyDown={(e) => {
                      if (e.key === "Enter" && sortedTags.length > 0) {
                        setTag(sortedTags[0]);
                        setTagInput("");
                        setShowTagDropdown(false);
                      }
                    }}
                    className="rounded border p-2 text-sm w-32"
                  />
                  {showTagDropdown && sortedTags.length > 0 && (
                    <div className="absolute top-full left-0 right-0 mt-1 bg-white border rounded shadow-lg z-10 max-h-40 overflow-y-auto">
                      {sortedTags.map(t => (
                        <div
                          key={t}
                          onClick={() => {
                            setTag(t);
                            setTagInput("");
                            setShowTagDropdown(false);
                          }}
                          className="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm"
                        >
                          {t}
                        </div>
                      ))}
                    </div>
                  )}
                  {tag && (
                    <div className="text-xs text-gray-500 mt-1">
                      å·²é€‰: <span className="font-semibold">{tag}</span>
                      <button
                        onClick={() => setTag("")}
                        className="ml-2 text-red-500 hover:text-red-700"
                      >
                        æ¸…é™¤
                      </button>
                    </div>
                  )}
                </div>
                <select
                  value={status}
                  onChange={(e) => setStatus(e.target.value)}
                  className="rounded border p-2 text-sm"
                >
                  <option value="">å…¨éƒ¨çŠ¶æ€</option>
                  <option value="open">å¾…åŠ</option>
                  <option value="done">å®Œæˆ</option>
                </select>
                <select
                  value={priority}
                  onChange={(e) => setPriority(e.target.value)}
                  className="rounded border p-2 text-sm"
                >
                  <option value="">å…¨éƒ¨é‡è¦ç¨‹åº¦</option>
                  {[1, 2, 3, 4, 5].map(n => <option key={n} value={n}>é‡è¦ç¨‹åº¦ {n}</option>)}
                </select>
                <select
                  value={urgency}
                  onChange={(e) => setUrgency(e.target.value)}
                  className="rounded border p-2 text-sm"
                >
                  <option value="">å…¨éƒ¨ç´§æ€¥ç¨‹åº¦</option>
                  {[1, 2, 3, 4, 5].map(n => <option key={n} value={n}>ç´§æ€¥ç¨‹åº¦ {n}</option>)}
                </select>
                <select
                  value={usageCount}
                  onChange={(e) => setUsageCount(e.target.value)}
                  className="rounded border p-2 text-sm"
                >
                  <option value="">å…¨éƒ¨ä½¿ç”¨æ¬¡æ•°</option>
                  {[1, 2, 3, 5, 10, 20, 50].map(n => <option key={n} value={n}>ä½¿ç”¨ {n} æ¬¡</option>)}
                </select>
              </div>
              <div className="flex gap-2">
                <button
                  onClick={() => setViewMode(viewMode === "grid" ? "list" : "grid")}
                  className="p-2 border rounded hover:bg-gray-100"
                >
                  {viewMode === "grid" ? <List size={20} /> : <Grid3x3 size={20} />}
                </button>
                <button
                  onClick={onQuickCreate}
                  disabled={creating}
                  className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2"
                >
                  <Plus size={20} />
                  åˆ›å»º Note
                </button>
              </div>
            </div>

            {/* Notes ç½‘æ ¼/åˆ—è¡¨ */}
            {filteredNotes.length === 0 ? (
              <div className="text-center py-12">
                <FileText size={48} className="mx-auto text-gray-300 mb-4" />
                <p className="text-gray-600">æ²¡æœ‰æ‰¾åˆ° Notes</p>
              </div>
            ) : viewMode === "grid" ? (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {filteredNotes.map((note) => (
                  <div
                    key={note.id}
                    onClick={() => onNoteClick(note.id)}
                    className="bg-white rounded-lg shadow hover:shadow-lg transition cursor-pointer p-6 group border-l-4"
                    style={{ borderLeftColor: note.tagsRel?.[0]?.color || "#e2e8f0" }}
                  >
                    <div className="flex justify-between items-start mb-3">
                      <h3 className="text-lg font-semibold text-slate-900 flex-1 line-clamp-2">
                        {note.title || "æ— æ ‡é¢˜"}
                      </h3>
                      <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                        <button
                          onClick={(e) => onDuplicate(note.id, e)}
                          disabled={duplicating === note.id}
                          className="p-1 text-slate-400 hover:text-blue-600"
                        >
                          <Copy size={16} />
                        </button>
                        <button
                          onClick={(e) => onDelete(note.id, e)}
                          disabled={deleting === note.id}
                          className="p-1 text-slate-400 hover:text-red-600"
                        >
                          <Trash2 size={16} />
                        </button>
                      </div>
                    </div>
                    <p className="text-sm text-slate-600 line-clamp-3 mb-4">{note.text}</p>
                    <div className="flex gap-2 flex-wrap">
                      {note.tagsRel?.slice(0, 3).map((tag) => (
                        <span
                          key={tag.id}
                          className="inline-block px-2 py-1 rounded text-xs font-semibold text-white"
                          style={{ backgroundColor: tag.color }}
                        >
                          {tag.name}
                        </span>
                      ))}
                      {note.tagsRel && note.tagsRel.length > 3 && (
                        <span className="inline-block px-2 py-1 text-xs text-gray-500">
                          +{note.tagsRel.length - 3}
                        </span>
                      )}
                    </div>
                    <div className="mt-4 text-xs text-gray-500 flex justify-between">
                      <span>ä¼˜å…ˆçº§: {note.priority || 3}</span>
                      <span>ä½¿ç”¨: {note.usageCount || 0}</span>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="bg-white rounded-lg shadow overflow-hidden">
                <table className="w-full">
                  <thead className="bg-gray-50 border-b">
                    <tr>
                      <th className="px-6 py-3 text-left text-sm font-semibold text-gray-900">æ ‡é¢˜</th>
                      <th className="px-6 py-3 text-left text-sm font-semibold text-gray-900">æ ‡ç­¾</th>
                      <th className="px-6 py-3 text-center text-sm font-semibold text-gray-900">ä¼˜å…ˆçº§</th>
                      <th className="px-6 py-3 text-center text-sm font-semibold text-gray-900">ä½¿ç”¨æ¬¡æ•°</th>
                      <th className="px-6 py-3 text-center text-sm font-semibold text-gray-900">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredNotes.map((note) => (
                      <tr
                        key={note.id}
                        onClick={() => onNoteClick(note.id)}
                        className="border-b hover:bg-gray-50 cursor-pointer"
                      >
                        <td className="px-6 py-4 font-medium text-slate-900">{note.title || "æ— æ ‡é¢˜"}</td>
                        <td className="px-6 py-4 text-sm">
                          {note.tagsRel?.slice(0, 2).map((tag) => (
                            <span
                              key={tag.id}
                              className="inline-block mr-2 px-2 py-1 rounded text-xs font-semibold text-white"
                              style={{ backgroundColor: tag.color }}
                            >
                              {tag.name}
                            </span>
                          ))}
                        </td>
                        <td className="px-6 py-4 text-center text-sm">{note.priority || 3}</td>
                        <td className="px-6 py-4 text-center text-sm">{note.usageCount || 0}</td>
                        <td className="px-6 py-4 text-center">
                          <button
                            onClick={(e) => onDuplicate(note.id, e)}
                            disabled={duplicating === note.id}
                            className="mr-2 text-blue-600 hover:text-blue-800"
                          >
                            å¤åˆ¶
                          </button>
                          <button
                            onClick={(e) => onDelete(note.id, e)}
                            disabled={deleting === note.id}
                            className="text-red-600 hover:text-red-800"
                          >
                            åˆ é™¤
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </>
        ) : (
          // ========== BOOKSHELVES TAB ==========
          <>
            {/* æ ‡é¢˜éƒ¨åˆ† */}
            <div className="mb-8 flex items-center justify-between">
              <div>
                <h1 className="text-4xl font-bold mb-2">æˆ‘çš„ä¹¦æ¶</h1>
                <p className="text-slate-600">æ•´ç†åˆ†ç±»çš„ç¬”è®° â€¢ {bookshelves.length} ä¸ªä¹¦æ¶</p>
              </div>
              <button
                onClick={() => {
                  // TODO: æ‰“å¼€åˆ›å»º Bookshelf å¯¹è¯æ¡†
                  alert("åˆ›å»ºæ–°ä¹¦æ¶åŠŸèƒ½å³å°†æ¨å‡º");
                }}
                className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2"
              >
                <Plus size={20} />
                æ–°å»ºä¹¦æ¶
              </button>
            </div>

            {/* Bookshelves ç½‘æ ¼ */}
            {bookshelves.length === 0 ? (
              <div className="text-center py-12">
                <BookOpen size={48} className="mx-auto text-gray-300 mb-4" />
                <p className="text-gray-600 mb-4">è¿˜æ²¡æœ‰ä¹¦æ¶ï¼Œåˆ›å»ºç¬¬ä¸€ä¸ªå§ï¼</p>
                <button
                  onClick={() => alert("åˆ›å»ºæ–°ä¹¦æ¶åŠŸèƒ½å³å°†æ¨å‡º")}
                  className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                >
                  åˆ›å»ºä¹¦æ¶
                </button>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {bookshelves.map((bs) => (
                  <button
                    key={bs.id}
                    onClick={() => router.push(`/orbit/bookshelves/${bs.id}`)}
                    className="bg-white rounded-lg shadow hover:shadow-lg transition p-6 text-left group border-l-4"
                    style={{ borderLeftColor: bs.color || "#3b82f6" }}
                  >
                    <div className="flex items-start justify-between mb-3">
                      <h3 className="text-xl font-bold text-slate-900 flex-1 line-clamp-2 group-hover:text-blue-600">
                        {bs.name}
                      </h3>
                      <span className="px-2 py-1 bg-slate-100 text-slate-600 rounded text-sm font-semibold">
                        {bs.noteCount}
                      </span>
                    </div>
                    {bs.description && (
                      <p className="text-sm text-slate-600 line-clamp-2 mb-4">{bs.description}</p>
                    )}
                    <div className="flex gap-4 text-xs text-slate-500">
                      <span>ä¼˜å…ˆçº§: {bs.priority || 3}</span>
                      <span>ä½¿ç”¨: {bs.usageCount}</span>
                    </div>
                  </button>
                ))}
              </div>
            )}
          </>
        )}
      </div>
    </main>
  );
}
