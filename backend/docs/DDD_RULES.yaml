# ============================================
# Wordloom v3 DDD 规则追踪系统
# ============================================
# 基于老架构分析和新业务需求
# 最后更新：2025-11-11

metadata:
  version: "3.0"
  domain_model: "Library → Bookshelf → Book → Block"
  architecture_style: "Hexagonal + Domain-Driven Design"
  aggregate_model: "Independent Aggregate Roots (不嵌套)"
  created_at: "2025-11-10"
  last_updated: "2025-11-12"

  # Phase 1 Implementation Status
  phase_1_status: "COMPLETED + ARCHITECTURE DECISION"
  phase_1_completion_date: "2025-11-11"
  architecture_refactor_date: "2025-11-12"
  modules_generated: 6  # Library, Bookshelf, Book, Block, Tag, Media
  files_generated: 56   # 6 modules × 8 files + shared/base.py + infra/storage.py + DDD_RULES.yaml

  # 迁移来源
  migrated_from: "OrbitBookshelf → Notes → tags/checkpoints/media"
  legacy_system: "WordloomBackend/orbit"

  # 代码仓库信息
  repository_path: "backend/domains/"
  shared_base_path: "backend/shared/base.py"
  infra_storage_path: "backend/infra/storage.py"

# ============================================
# Domain 1: Library（图书馆 - 聚合根）
# ============================================

domains:
  library:
    name: "Library（图书馆）"
    type: "AggregateRoot"
    description: "用户的唯一数据容器，所有书架、书籍、块的顶层容器。代表用户的完整知识库。"
    status: "implemented"

    implementation_files:
      - "backend/domains/library/domain.py"
      - "backend/domains/library/models.py"
      - "backend/domains/library/schemas.py"
      - "backend/domains/library/repository.py"
      - "backend/domains/library/service.py"
      - "backend/domains/library/router.py"
      - "backend/domains/library/exceptions.py"
      - "backend/domains/library/conftest.py"

    # 从老架构的演变
    legacy_source: |
      - 老架构中 Bookshelves 表是复数形式，代表多个书橱
      - v3 中统一为 Library（单数），每个用户 1 个
      - 提升一层以便支持分享/权限/导出等 Library 级操作

    invariants:
      RULE-001:
        title: "每个用户只拥有一个 Library"
        statement: "User 与 Library 是 1:1 关系，不能创建多个 Library，不能删除。"
        type: "invariant"
        priority: "critical"
        status: "planned"

        implementation:
          domain_file: "backend/api/app/modules/library/domain.py"
          test_file: "backend/api/app/tests/test_library/test_invariants.py"
          orm_file: "backend/api/app/modules/library/models.py"

        code_example: |
          class Library(AggregateRoot):
              id: UUID
              user_id: UUID  # 唯一约束：(user_id) 组合 unique
              name: str
              created_at: datetime
              updated_at: datetime

              def __post_init__(self):
                  # 在 Repository 中强制此约束
                  # 如果 user_id 已有 Library，raise DuplicateLibraryError
                  pass

        validation:
          method: "pytest + SQLAlchemy unique constraint"
          test_case: "test_library_one_per_user"

        related_files:
          - "backend/api/app/modules/library/repository.py"
          - "backend/api/app/modules/library/service.py"

        devlog_entry: "D30-Library-SingleInstance"
        pr_number: null

      RULE-002:
        title: "Library 拥有唯一的用户身份"
        statement: "Library 必须关联到一个有效的 User，不能为空。"
        type: "invariant"
        priority: "critical"
        status: "planned"

        implementation:
          domain_file: "backend/api/app/modules/library/domain.py"
          test_file: "backend/api/app/tests/test_library/test_invariants.py"

        devlog_entry: "D30-Library-UserAssociation"

      RULE-003:
        title: "Library 包含唯一的名称"
        statement: "Library 的名称应该反映用户的身份或知识库主题，通常为用户名或'我的知识库'。"
        type: "invariant"
        priority: "high"
        status: "planned"

        devlog_entry: "D30-Library-UniqueName"

    policies:
      POLICY-001:
        title: "Library 分享和权限管理"
        statement: "Library 可以与其他用户分享（只读或可编辑），支持不同的权限级别。"
        type: "policy"
        status: "future"  # 暂不实现

        devlog_entry: "D32-Library-Sharing"

      POLICY-002:
        title: "Library 导出和备份"
        statement: "支持将整个 Library 导出为 JSON 或 Markdown 格式，支持定期备份。"
        type: "policy"
        status: "future"

        devlog_entry: "D32-Library-Export"

    events:
      LibraryCreated:
        description: "Library 被创建（通常由系统在 User 注册时自动创建）"
        fields:
          - library_id: UUID
          - user_id: UUID
          - created_at: datetime

      LibraryUpdated:
        description: "Library 信息被更新"
        fields:
          - library_id: UUID
          - user_id: UUID
          - updated_at: datetime

    children:
      - bookshelf

# ============================================
# Domain 2: Bookshelf（书架 - 子聚合）
# ============================================

  bookshelf:
    name: "Bookshelf（书架）"
    type: "AggregateRoot"
    description: "Library 下的第一级容器，用于组织和分类 Books。"
    parent: "library"
    status: "planned"

    # 从老架构的演变
    legacy_source: |
      - 对应老架构中的 OrbitBookshelf 表
      - 移除了"用户可创建多个"的假设，改为明确归属于 Library
      - 保留了所有字段：name, description, cover_url, icon, priority, urgency, tags, color

    # 架构实现分层（ADR-005: Bookshelf Domain Simplification）
    implementation_layers:
      domain_layer:
        file: "backend/api/app/modules/domains/bookshelf/domain.py"
        line_count: "~290 LOC (精简后，从 350 LOC -17%)"
        responsibilities:
          - "BookshelfName/BookshelfDescription 值对象验证（RULE-006）"
          - "Bookshelf.create() 工厂方法（RULE-004）"
          - "rename() 核心业务方法"
          - "change_status() 状态管理（RULE-010）"
          - "mark_deleted() 删除操作"
          - "mark_as_basement() Basement 支持（RULE-010）"
          - "发出 BookshelfCreated/Renamed/StatusChanged/Deleted 事件"

      service_layer:
        file: "backend/api/app/modules/domains/bookshelf/service.py"
        line_count: "~180 LOC（扩展后，从 120 LOC +50%）"
        core_operations:
          - "create_bookshelf() - RULE-004 创建"
          - "get_bookshelf() / list_bookshelves() - RULE-005 查询"
          - "rename_bookshelf() - RULE-006 重命名"
          - "delete_bookshelf() - 删除协调"

        auxiliary_features:
          - "pin_bookshelf() / unpin_bookshelf() - UI 便利"
          - "favorite_bookshelf() / unfavorite_bookshelf() - UI 便利"
          - "archive_bookshelf() / unarchive_bookshelf() - 状态编排"

        query_methods_moved_from_domain:
          - "set_description() - 元数据管理（新增，曾在 Domain）"
          - "can_accept_books() - 业务规则（新增，曾在 Domain）"
          - "is_active() - 状态查询（新增，曾在 Domain）"
          - "is_archived() - 状态查询（新增，曾在 Domain）"
          - "is_deleted() - 状态查询（新增，曾在 Domain）"

      repository_layer:
        file: "backend/api/app/modules/domains/bookshelf/repository.py"
        responsibilities:
          - "get_by_id(bookshelf_id) - 单体查询"
          - "get_by_library_id(library_id) - 列表查询"
          - "save(bookshelf) - 持久化 + 事件"
          - "delete(bookshelf_id) - 物理删除"

    invariants:
      RULE-004:
        title: "Bookshelf 可无限创建"
        statement: "用户可在 Library 下无限创建 Bookshelf，无数量限制。每个 Bookshelf 独立存在，通过 library_id FK 关联。"
        type: "invariant"
        priority: "critical"
        status: "implemented"

        implementation:
          domain_file: "backend/api/app/modules/domains/bookshelf/domain.py (Line: create())"
          orm_constraint: "bookshelf.library_id FK → libraries.id"

        design_note: "独立聚合根模式：Bookshelf 不嵌套在 Library 内"

        devlog_entry: "D31-Bookshelf-Unlimited"

      RULE-005:
        title: "Bookshelf 必须属于一个 Library"
        statement: "每个 Bookshelf 必须持有其所属 Library 的 ID（FK: library_id），不能孤立存在。"
        type: "invariant"
        priority: "critical"
        status: "implemented"

        code_example: |
          class Bookshelf(AggregateRoot):
              id: UUID
              library_id: UUID  # ← 强制 FK，不是 Library 对象
              type: BookshelfType  # NORMAL or BASEMENT
              is_hidden: bool  # Basement 为 True

        implementation:
          domain_file: "backend/api/app/modules/domains/bookshelf/domain.py (Line: __init__)"

        devlog_entry: "D31-Bookshelf-BelongsToLibrary"

      RULE-006:
        title: "Bookshelf 的名称不能为空"
        statement: "创建 Bookshelf 时，name 字段必须非空且不能全为空格，≤255 字符。"
        type: "invariant"
        priority: "high"
        status: "implemented"

        implementation:
          domain_file: "backend/api/app/modules/domains/bookshelf/domain.py (BookshelfName.value_object, __post_init__)"
          service_file: "backend/api/app/modules/domains/bookshelf/service.py (rename_bookshelf(), create_bookshelf())"
          validation_layers:
            - "Router (Pydantic): min_length=1, max_length=255"
            - "Domain (ValueObject): __post_init__ 检查非空和长度"
            - "Database (ORM): String(255) NOT NULL"

        devlog_entry: "D31-Bookshelf-NameNotEmpty"

      RULE-010:
        title: "每个 Library 自动创建一个 Basement Bookshelf"
        statement: "系统创建 Library 时，自动创建一个隐藏的 Basement Bookshelf（回收站）。"
        type: "invariant"
        priority: "critical"
        status: "implemented"

        code_example: |
          # 创建 Library 时自动触发
          library = Library.create(user_id, "My Library")
          # 自动发出两个事件：
          # - LibraryCreated
          # - BasementCreated(basement_bookshelf_id=...)

        implementation:
          domain_file: "backend/api/app/modules/domains/library/domain.py (Line: BasementCreated event)"
          service_file: "backend/api/app/modules/domains/library/service.py"

        design_note: "Basement 是特殊的 Bookshelf（BookshelfType.BASEMENT），隐藏且不能删除"

        devlog_entry: "D31-Library-BasementAutoCreate"

    policies:
      POLICY-003:
        title: "Bookshelf 删除时的 Book 处理"
        statement: |
          当删除 Bookshelf 时，其内的 Books 需要处理：
          选项1（推荐）：将所有 Book 转移到 Basement
          选项2：级联删除所有 Book（不推荐，用户体验差）
        type: "policy"
        status: "pending_decision"  # 需在 Service 层明确实现

        devlog_entry: "D31-Bookshelf-DeletePolicy"

      POLICY-006:
        title: "Basement 中 Book 的自动清理"
        statement: "Basement 中存储超过 30 天的 Book，由外部 Job 自动硬删除（purge_basement）。"
        type: "policy"
        status: "future"

        implementation:
          service_file: "backend/api/app/modules/domains/book/service.py (purge_basement)"
          trigger: "AsyncTask / Celery Job (每天午夜)"

        devlog_entry: "D31-Book-BasementAutoCleanup"

    events:
      BookshelfCreated:
        description: "新 Bookshelf 被创建"
        fields:
          - bookshelf_id: UUID
          - library_id: UUID
          - name: str
          - type: BookshelfType (NORMAL or BASEMENT)

      BookshelfRenamed:
        description: "Bookshelf 名称被更改（核心事件）"
        fields:
          - bookshelf_id: UUID
          - old_name: str
          - new_name: str

      BookshelfStatusChanged:
        description: "Bookshelf 状态改变（核心事件，ACTIVE/ARCHIVED/DELETED）"
        fields:
          - bookshelf_id: UUID
          - old_status: BookshelfStatus
          - new_status: BookshelfStatus

      BookshelfDeleted:
        description: "Bookshelf 被删除（Basement 不能被删除，核心事件）"
        fields:
          - bookshelf_id: UUID
          - library_id: UUID

      # ← REMOVED (moved to Service layer per AD-004)
      # BookshelfPinned, BookshelfUnpinned, BookshelfFavorited, BookshelfUnfavorited
      # These are now handled by Service layer auxiliary methods (pin_bookshelf, favorite_bookshelf, etc.)
      # See: bookshelf/service.py and AD-004 (Auxiliary Features Layering)

    children:
      - book

# ============================================
# Domain 3: Book（书籍 - 独立聚合根）
# ============================================

  book:
    name: "Book（书籍）"
    type: "AggregateRoot"
    description: "独立聚合根，通过 bookshelf_id FK 关联到 Bookshelf。存储结构化内容（Blocks）。对应老架构中的 OrbitNote。"
    parent: "bookshelf"
    status: "implemented"

    # 从老架构的演变
    legacy_source: |
      - 对应老架构中的 OrbitNote 表
      - 保留字段：id, title, summary, content_md, preview_image, priority, urgency, tags, status
      - 新增字段：blocks（从 blocks_json 扁平化出来）
      - 新增关系：has_many :blocks
      - 移除字段：blocks_json（被 Block 实体替代）
      - 新增字段：soft_deleted_at（用于 Basement 标记）

    # Phase 5 优化后的实现分布（ADR-006）
    implementation_layers:
      domain_layer:
        file: "backend/api/app/modules/domains/book/domain.py"
        lines_of_code: 370
        percentage: "38%"
        responsibilities:
          - "Factory method: create() with library_id initialization"
          - "Core operations: rename(), change_status()"
          - "Transfer semantics: move_to_bookshelf(), move_to_basement(), restore_from_basement()"
          - "Block management: update_block_count()"
          - "Query properties: is_draft, is_published, is_archived, is_deleted, can_edit, is_in_basement"
          - "Domain events: BookCreated, BookRenamed, BookStatusChanged, BookMovedToBookshelf, BookMovedToBasement, BookRestoredFromBasement, BlocksUpdated"
        core_methods:
          - "create(bookshelf_id, library_id, title, summary)"
          - "rename(new_title)"
          - "change_status(new_status)"
          - "move_to_bookshelf(new_bookshelf_id)"
          - "move_to_basement(basement_bookshelf_id)"
          - "restore_from_basement(restore_to_bookshelf_id)"

      service_layer:
        file: "backend/api/app/modules/domains/book/service.py"
        lines_of_code: 150
        percentage: "16%"
        responsibilities:
          - "Orchestration: create_book() with library_id validation"
          - "Core operations: rename_book(), publish_book(), archive_book()"
          - "Soft delete: delete_book() with basement transfer"
          - "Transfer with permission checks: move_to_bookshelf() validates target Bookshelf"
          - "Basement operations: move_to_basement(), restore_from_basement()"
          - "Auxiliary features (moved from domain): set_summary(), set_due_date(), pin_book(), unpin_book()"
          - "Query methods (service layer wrappers): is_draft(), is_published(), is_archived(), is_deleted(), can_edit()"
        auxiliary_methods:
          - "set_summary(book_id, summary)"
          - "set_due_date(book_id, due_at)"
          - "pin_book(book_id)"
          - "unpin_book(book_id)"
          - "is_draft(book_id)"
          - "is_published(book_id)"
          - "is_archived(book_id)"
          - "is_deleted(book_id)"
          - "can_edit(book_id)"
        permission_validations:
          - "Verify target Bookshelf exists"
          - "Verify target Bookshelf belongs to same Library (library_id consistency)"
          - "Reject manual moves to Basement"
          - "Initialize library_id from parent Bookshelf in create_book()"

      repository_layer:
        file: "backend/api/app/modules/domains/book/repository.py"
        responsibilities:
          - "get_by_id(book_id)"
          - "get_by_bookshelf_id(bookshelf_id)"
          - "save(book)"
          - "delete(book_id)"

    invariants:
      RULE-009:
        title: "Book 可无限创建"
        statement: |
          用户可在 Bookshelf 下无限创建 Book，无数量限制。
          创建时必须正确初始化 library_id（从父 Bookshelf 获取）。
        type: "invariant"
        priority: "critical"
        status: "implemented"

        code_example: |
          # Domain 层
          book = Book.create(
              bookshelf_id=bookshelf_id,
              library_id=library_id,  # ← 必须传入（冗余 FK）
              title=title,
              summary=summary
          )

        implementation:
          domain_file: "backend/api/app/modules/domains/book/domain.py (Line: create())"
          service_file: "backend/api/app/modules/domains/book/service.py (Line: create_book())"

        design_note: "Service 层负责从 Bookshelf 获取 library_id 并传给 Domain"

        devlog_entry: "D32-Book-Unlimited"

      RULE-011:
        title: "Book 可跨 Bookshelf 转移（带权限检查）"
        statement: |
          Book 可以从一个 Bookshelf 转移到另一个（真实转移，不是复制）。
          转移时 Book ID 不变，必须验证：
          1. 目标 Bookshelf 存在
          2. 目标 Bookshelf 属于同一个 Library（library_id 一致）
          3. 目标 Bookshelf 不是 Basement
        type: "invariant"
        priority: "critical"
        status: "implemented"

        code_example: |
          # Domain 层：真实转移
          book.move_to_bookshelf(new_bookshelf_id)
          # 发出事件：BookMovedToBookshelf(old_id, new_id, book_id)

          # Service 层：权限检查
          async def move_to_bookshelf(self, book_id, target_id):
              book = await self.get_book(book_id)

              # 验证目标存在且合法
              target_shelf = await self.bookshelf_repo.get_by_id(target_id)
              if not target_shelf:
                  raise BookshelfNotFoundError()
              if target_shelf.library_id != book.library_id:
                  raise PermissionError("Different Library")
              if target_shelf.is_basement:
                  raise ValueError("Cannot move to Basement")

              book.move_to_bookshelf(target_id)
              await self.repository.save(book)

        implementation:
          domain_file: "backend/api/app/modules/domains/book/domain.py (Line: move_to_bookshelf())"
          service_file: "backend/api/app/modules/domains/book/service.py (Line: move_to_bookshelf())"

        design_note: "Move Semantics（真转移）+ 三层权限检查（存在、一致、Basement）"

        devlog_entry: "D32-Book-Move (ADR-006)"

      RULE-012:
        title: "Book 删除时转移到 Basement（软删除）"
        statement: |
          删除 Book 时，不硬删除，而是调用 move_to_basement(basement_id)。
          Book 仍存在数据库，但 soft_deleted_at 被设置，bookshelf_id 变为 basement_id。
          Service 层必须正确处理：调用 Domain 转移方法，然后 save() 不 delete()。
        type: "invariant"
        priority: "critical"
        status: "implemented"

        code_example: |
          # 删除 Book（实际是转移到 Basement）
          book.move_to_basement(basement_id)
          # soft_deleted_at 被设置为当前时间
          # 发出事件：BookMovedToBasement(...)

          # Service 层实现
          async def delete_book(self, book_id, basement_id):
              book = await self.get_book(book_id)
              book.move_to_basement(basement_id)  # ← Domain 方法
              await self.repository.save(book)   # ← 只保存，不删除！
              # ❌ NOT await self.repository.delete(book_id)

        implementation:
          domain_file: "backend/api/app/modules/domains/book/domain.py (Line: move_to_basement())"
          service_file: "backend/api/app/modules/domains/book/service.py (Line: delete_book())"

        design_note: "Basement 模式：软删除 + 回收站，30 天后自动硬删除。Service 层确保不硬删除。"

        devlog_entry: "D32-Book-SoftDelete (ADR-006)"

      RULE-013:
        title: "Book 可从 Basement 恢复"
        statement: |
          Basement 中的 Book 可调用 restore_from_basement(target_bookshelf_id) 恢复。
          恢复时 soft_deleted_at 被清除，bookshelf_id 变为目标 Bookshelf。
          必须验证目标 Bookshelf 属于同一 Library。
        type: "invariant"
        priority: "high"
        status: "implemented"

        code_example: |
          # 从 Basement 恢复
          book.restore_from_basement(restore_to_bookshelf_id)
          # soft_deleted_at 被清除为 None
          # bookshelf_id 变为新地址
          # 发出事件：BookRestoredFromBasement(...)

        implementation:
          domain_file: "backend/api/app/modules/domains/book/domain.py (Line: restore_from_basement())"
          service_file: "backend/api/app/modules/domains/book/service.py (Line: restore_from_basement())"

        devlog_entry: "D32-Book-Restore (ADR-006)"

    policies:
      POLICY-005:
        title: "Book 转移时的权限检查"
        statement: |
          Book 转移到新 Bookshelf 时，Service 层需验证：
          1. 新 Bookshelf 存在
          2. 新 Bookshelf 属于同一个 Library（library_id 一致）
          3. 新 Bookshelf 不是 Basement（用户不能主动转移到 Basement）
        type: "policy"
        status: "implemented"

        implementation:
          service_file: "backend/api/app/modules/domains/book/service.py (Line: move_to_bookshelf())"

        devlog_entry: "D32-Book-MovePolicy (ADR-006)"

      POLICY-007:
        title: "Basement 中 Book 的自动清理"
        statement: "Basement 中存储超过 30 天的 Book，由外部 Job 自动硬删除。"
        type: "policy"
        status: "future"

        implementation:
          service_file: "backend/api/app/modules/domains/book/service.py (Line: purge_basement)"
          trigger: "Celery / APScheduler Job（每天午夜）"

        devlog_entry: "D32-Book-PurgeBasement"

    events:
      BookCreated:
        description: "新 Book 被创建"
        fields:
          - book_id: UUID
          - bookshelf_id: UUID
          - library_id: UUID
          - title: str

      BookMovedToBookshelf:
        description: "Book 转移到另一个 Bookshelf"
        fields:
          - book_id: UUID
          - old_bookshelf_id: UUID
          - new_bookshelf_id: UUID
          - moved_at: datetime

      BookMovedToBasement:
        description: "Book 被删除（转移到 Basement）"
        fields:
          - book_id: UUID
          - old_bookshelf_id: UUID
          - basement_bookshelf_id: UUID
          - deleted_at: datetime

      BookRestoredFromBasement:
        description: "Book 从 Basement 恢复"
        fields:
          - book_id: UUID
          - basement_bookshelf_id: UUID
          - restored_to_bookshelf_id: UUID
          - restored_at: datetime

      BookStatusChanged:
        description: "Book 状态变更（draft → published → archived → deleted）"
        fields:
          - book_id: UUID
          - old_status: BookStatus
          - new_status: BookStatus

    children:
      - block

    policies:
      POLICY-005:
        title: "Book 删除策略"
        statement: "删除 Book 时，级联删除其下所有 Blocks 和关联的媒体资源。"
        type: "policy"
        status: "planned"

        implementation:
          domain_file: "backend/api/app/modules/book/domain.py"

        devlog_entry: "D33-Book-CascadingDelete"

      POLICY-006:
        title: "Book 转移策略"
        statement: "支持将 Book 从一个 Bookshelf 转移到另一个，或变为自由 Book。"
        type: "policy"
        status: "planned"

        devlog_entry: "D33-Book-Transfer"

    events:
      BookCreated:
        description: "Book 被创建（核心事件）"
        fields:
          - book_id: UUID
          - bookshelf_id: UUID
          - title: str

      BookRenamed:
        description: "Book 标题被改变（核心事件）"
        fields:
          - book_id: UUID
          - old_title: str
          - new_title: str

      BookStatusChanged:
        description: "Book 状态改变（核心事件，DRAFT/PUBLISHED/ARCHIVED/DELETED）"
        fields:
          - book_id: UUID
          - old_status: BookStatus
          - new_status: BookStatus

      BookDeleted:
        description: "Book 被删除（核心事件，软删除）"
        fields:
          - book_id: UUID
          - bookshelf_id: UUID

      BookMovedToBookshelf:
        description: "Book 被转移到不同 Bookshelf（核心事件）"
        fields:
          - book_id: UUID
          - old_bookshelf_id: UUID
          - new_bookshelf_id: UUID
          - moved_at: datetime

      BookMovedToBasement:
        description: "Book 被转移到 Basement（删除，核心事件）"
        fields:
          - book_id: UUID
          - old_bookshelf_id: UUID
          - basement_bookshelf_id: UUID
          - deleted_at: datetime

      BookRestoredFromBasement:
        description: "Book 从 Basement 恢复（核心事件）"
        fields:
          - book_id: UUID
          - basement_bookshelf_id: UUID
          - restored_to_bookshelf_id: UUID
          - restored_at: datetime

      BlocksUpdated:
        description: "Book 的 Blocks 更新（核心事件，用于块计数）"
        fields:
          - book_id: UUID
          - block_count: int

      # ← REMOVED (moved to Service layer per AD-004)
      # BookPinned, BookUnpinned
      # These are now handled by Service layer auxiliary methods (pin_book, unpin_book)
      # See: book/service.py and AD-004 (Auxiliary Features Layering)

    children:
      - block

# ============================================
# Domain 4: Block（块 - 值对象/最小单位）
# ============================================

  block:
    name: "Block（块）"
    type: "AggregateRoot"
    description: "独立聚合根，通过 book_id FK 关联到 Book。最小内容单位，支持多种类型。从老架构的 blocks_json 扁平化出来。"
    parent: "book"
    status: "implemented"

    # 从老架构的演变
    legacy_source: |
      - 老架构中存储在 OrbitNote.blocks_json 中为 JSON 数组
      - v3 将其独立为数据库表和实体
      - 支持的类型：text, code, image, table, checkpoint, translation, media, etc.
      - 新增字段：metadata（用于存储类型特定的数据）
      - 设计为独立聚合根（不嵌套在 Book 内）

    # Phase 5 优化后的实现分布（ADR-007）
    implementation_layers:
      domain_layer:
        file: "backend/api/app/modules/domains/block/domain.py"
        lines_of_code: 450
        percentage: "40-42%"
        responsibilities:
          - "Factory methods: create(), create_text_block(), create_heading_block(), create_image_block(), create_code_block()"
          - "Core operations: set_content(), set_order(), set_title(), remove_title()"
          - "Soft delete: mark_deleted()"
          - "Query methods: is_heading, heading_level, is_image"
          - "Domain events: BlockCreated, BlockContentChanged, BlockReordered, BlockTitleChanged, BlockDeleted"
        core_methods:
          - "create(book_id, block_type, content, order)"
          - "set_content(new_content)"
          - "set_order(new_order)"
          - "set_title(title, level)"
          - "remove_title()"
          - "mark_deleted()"

      service_layer:
        file: "backend/api/app/modules/domains/block/service.py"
        lines_of_code: 90
        percentage: "8-10%"
        responsibilities:
          - "Orchestration: create_block() with Book validation"
          - "Content management: update_block_content() with permission check"
          - "Ordering: reorder_block() with permission check"
          - "Soft delete: delete_block() with permission check"
          - "Retrieval: get_block(), list_blocks()"
        permission_validations:
          - "Verify Book exists (repository.get_by_id)"
          - "Verify user ownership via Library (user_id → library.user_id match)"
          - "Validate book_id consistency"
        methods:
          - "create_block(book_id, block_type, content, order, user_id)"
          - "update_block_content(block_id, new_content, user_id)"
          - "reorder_block(block_id, new_order, user_id)"
          - "delete_block(block_id, user_id)"
          - "get_block(block_id)"
          - "list_blocks(book_id)"

      repository_layer:
        file: "backend/api/app/modules/domains/block/repository.py"
        responsibilities:
          - "get_by_id(block_id)"
          - "get_by_book_id(book_id)"
          - "save(block)"
          - "Query soft-deleted blocks: get_deleted_blocks()"

    invariants:
      RULE-013:
        title: "Block 可无限创建"
        statement: "用户可在 Book 下无限创建 Block，无数量限制。每个 Block 独立操作。"
        type: "invariant"
        priority: "critical"
        status: "implemented"

        design_note: "独立聚合根模式：Block 不嵌套在 Book 内，编辑时无需锁 整个 Book"

        implementation:
          domain_file: "backend/api/app/modules/domains/block/domain.py (Line: create())"

        devlog_entry: "D33-Block-Unlimited"

      RULE-014:
        title: "Block 必须有 type"
        statement: "每个 Block 必须有 type（TEXT|HEADING_1-3|IMAGE|CODE|TABLE|QUOTE|LIST）。"
        type: "invariant"
        priority: "critical"
        status: "implemented"

        code_example: |
          class Block(AggregateRoot):
              id: UUID
              book_id: UUID        # ← FK（不是 Book 对象）
              bookshelf_id: UUID   # ← 冗余 FK（用于 Bookshelf 删除时级联）
              library_id: UUID     # ← 冗余 FK（用于权限检查）
              block_type: BlockType  # Enum: TEXT, CODE, IMAGE, ...
              content: str         # 主要内容
              order: int           # 排序位置
              title: Optional[BlockTitle]  # 可选：用于层级标题

        implementation:
          domain_file: "backend/api/app/modules/domains/block/domain.py (Line: __init__)"

        design_note: "采用 Enum 而非字符串，类型安全"

        devlog_entry: "D33-Block-MustHaveType"

      RULE-015:
        title: "Block 有序排列"
        statement: "Block 通过 order 字段按升序排列，移动 Block 时重新计算顺序。支持拖拽排序。"
        type: "invariant"
        priority: "high"
        status: "implemented"

        design_note: "Flat structure，不支持嵌套 Marker"

        implementation:
          domain_file: "backend/api/app/modules/domains/block/domain.py (Line: set_order())"

        devlog_entry: "D33-Block-Ordering"

      RULE-016:
        title: "Block 必须属于一个 Book"
        statement: |
          每个 Block 必须持有其所属 Book 的 ID（FK: book_id）。
          同时持有 bookshelf_id 和 library_id 用于级联和权限。
        type: "invariant"
        priority: "critical"
        status: "implemented"

        design_note: "独立聚合根模式：冗余 FK 用于优化查询和级联操作"

        implementation:
          domain_file: "backend/api/app/modules/domains/block/domain.py (Line: __init__)"

        devlog_entry: "D33-Block-BelongsToBook"

      RULE-017:
        title: "Block 支持标题层级（可选）"
        statement: |
          Block 可选择设置 title 和 title_level（1-3）用于建立层级结构。
          - title_level=1: H1 级标题
          - title_level=2: H2 级标题
          - title_level=3: H3 级标题
          - title_level=None: 普通内容块
        type: "invariant"
        priority: "high"
        status: "implemented"

        code_example: |
          # 设置标题
          block.set_title("Introduction", level=1)
          # 或移除标题
          block.remove_title()

        implementation:
          domain_file: "backend/api/app/modules/domains/block/domain.py (set_title/remove_title methods)"

        design_note: "Flat structure with title hierarchy，比嵌套更简单"

        devlog_entry: "D33-Block-TitleHierarchy"

    policies:
      POLICY-008:
        title: "Block 删除策略（软删除）"
        statement: "删除 Block 时，不硬删除，而是标记为 soft_deleted。由定期 purge job 清理 30+ 天的 Block 及其媒体。"
        type: "policy"
        status: "implemented"

        implementation:
          service_file: "backend/api/app/modules/domains/block/service.py (Line: delete_block())"
          domain_file: "backend/api/app/modules/domains/block/domain.py (Line: mark_deleted())"

        devlog_entry: "D33-Block-SoftDelete (ADR-007)"

      POLICY-009:
        title: "Bookshelf 删除时的 Block 级联"
        statement: |
          Bookshelf 删除时，需清理其内所有 Books 的所有 Blocks。
          实现方式：
          1. 查询所有 bookshelf_id = X 的 Blocks（冗余 FK）
          2. 仅标记为 soft_deleted（不硬删除）
          3. 由 purge job 在 30+ 天后硬删除及其媒体
          4. 然后删除 Books
        type: "policy"
        status: "implemented"

        implementation:
          service_file: "backend/api/app/modules/domains/bookshelf/service.py"

        devlog_entry: "D33-Bookshelf-BlockCascade (ADR-007)"

    events:
      BlockCreated:
        description: "新 Block 被创建"
        fields:
          - block_id: UUID
          - book_id: UUID
          - block_type: BlockType
          - order: int

      BlockContentChanged:
        description: "Block 内容被修改"
        fields:
          - block_id: UUID
          - occurred_at: datetime

      BlockReordered:
        description: "Block 顺序被改变（拖拽）"
        fields:
          - block_id: UUID
          - old_order: int
          - new_order: int

      BlockTitleSet:
        description: "Block 标题被设置或变更"
        fields:
          - block_id: UUID
          - title_level: Optional[int]
          - title_text: Optional[str]

      BlockDeleted:
        description: "Block 被删除"
        fields:
          - block_id: UUID
          - book_id: UUID

      POLICY-008:
        title: "Block 类型检验"
        statement: "新增 Block 时，必须验证 type 在允许列表内，metadata 符合 type 的约束。"
        type: "policy"
        status: "planned"

        devlog_entry: "D33-Block-TypeValidation"

    events:
      BlockCreated:
        description: "Block 被创建"

      BlockUpdated:
        description: "Block 被更新"

      BlockDeleted:
        description: "Block 被删除"

      BlockMoved:
        description: "Block 的顺序改变"

# ============================================
# Domain 5: Tag（全局标签 - 值对象）
# ============================================

  tag:
    name: "Tag（标签）"
    type: "ValueObject"
    description: "全局标签系统，与 Book 多对多关联。菜单栏绑定，支持过滤和搜索。对应老架构中的 OrbitTag。"
    status: "planned"

    # 从老架构的演变
    legacy_source: |
      - 对应老架构中的 OrbitTag 表
      - 保留 N:N 关系（通过 BookTag 关联表）
      - 新增"菜单栏绑定"的概念（用户可通过菜单栏点击 Tag 来过滤）
      - 保留字段：id, name, color, icon, description, count（使用次数缓存）

    invariants:
      RULE-018:
        title: "Tag 名称全局唯一"
        statement: "每个 Tag 的名称必须唯一（unique constraint in DB）。"
        type: "invariant"
        priority: "critical"
        status: "planned"

        implementation:
          domain_file: "backend/api/app/modules/tag/domain.py"

        devlog_entry: "D34-Tag-UniqueName"

      RULE-019:
        title: "Tag 与 Book 多对多关联"
        statement: "一个 Tag 可关联多个 Books，一个 Book 可有多个 Tags。"
        type: "invariant"
        priority: "critical"
        status: "planned"

        code_example: |
          class Tag(ValueObject):
              id: UUID
              name: str  # unique
              color: str
              icon: str | None
              description: str | None
              books: List[Book] = relationship(secondary="book_tags")

        devlog_entry: "D34-Tag-BookAssociation"

      RULE-020:
        title: "Tag 支持颜色和图标"
        statement: "每个 Tag 可以设置颜色（十六进制）和图标（Lucide 图标名）用于 UI 展示。"
        type: "invariant"
        priority: "medium"
        status: "planned"

        devlog_entry: "D34-Tag-UIProperties"

    policies:
      POLICY-009:
        title: "Tag 删除策略"
        statement: "删除 Tag 时，自动从所有 Books 移除关联。"
        type: "policy"
        status: "planned"

        devlog_entry: "D34-Tag-DeletionCleanup"

      POLICY-010:
        title: "Tag 菜单栏集成"
        statement: "用户可以在菜单栏点击 Tag 来过滤显示的 Books，支持多 Tag 并集过滤。"
        type: "policy"
        status: "planned"

        devlog_entry: "D34-Tag-MenubarIntegration"

    events:
      TagCreated:
        description: "Tag 被创建"

      TagUpdated:
        description: "Tag 被更新"

      TagDeleted:
        description: "Tag 被删除"

# ============================================
# Domain 6: Chronicle（新增 - 时间追踪）
# ============================================

  chronicle:
    name: "Chronicle（编年史 / 工作日记）"
    type: "AggregateRoot"
    description: "会话级别的时间追踪和日志记录。从老架构的 Checkpoint 分离出来，专门处理时间维度的数据。"
    status: "planned"

    # 从老架构的演变
    legacy_source: |
      - 老架构中 Checkpoint 和 Marker 用于记录工作时间
      - v3 将时间追踪功能独立为 Chronicle 模块
      - 概念重新定义：
        - Session = 一个工作会话（可选与某个 Book 关联）
        - TimeSegment = 工作时间分片（类似老 Marker）
      - 新增功能：Session 汇总、效率分析、Tag 关联

    core_entities:
      Session:
        description: "一个独立的工作会话"
        fields:
          - id: UUID
          - user_id: UUID  # 所属用户
          - book_id: UUID | None  # 可选关联到具体的 Book
          - started_at: datetime
          - ended_at: datetime | None  # null = 进行中
          - title: str  # 会话标题（如"Python 学习"）
          - description: str | None
          - tags: List[UUID]  # 关联的 Tag IDs
          - time_segments: List[TimeSegment]
          - total_duration: int  # 秒数（计算属性）

      TimeSegment:
        description: "Session 内的时间分片"
        fields:
          - id: UUID
          - session_id: UUID
          - started_at: datetime
          - ended_at: datetime
          - duration_seconds: int
          - category: str  # work, pause, break, review, etc.
          - title: str | None
          - description: str | None
          - image_urls: List[str]  # 最多 5 张图片（60x60）
          - tags: List[UUID]  # TimeSegment 级别的 Tag

    invariants:
      RULE-021:
        title: "Session 必须有开始时间"
        statement: "创建 Session 时，started_at 必须填写。"
        type: "invariant"
        priority: "critical"
        status: "planned"

        devlog_entry: "D35-Chronicle-SessionStartTime"

      RULE-022:
        title: "TimeSegment 的时间范围有效性"
        statement: "TimeSegment 的 ended_at 必须 >= started_at，duration_seconds 自动计算。"
        type: "invariant"
        priority: "high"
        status: "planned"

        devlog_entry: "D35-Chronicle-TimeSegmentValidity"

      RULE-023:
        title: "Session 可选关联到 Book"
        statement: "Session 的 book_id 可以为 null，表示通用工作会话；也可指向具体的 Book。"
        type: "invariant"
        priority: "medium"
        status: "planned"

        devlog_entry: "D35-Chronicle-SessionBookAssociation"

    policies:
      POLICY-011:
        title: "Session 自动计算总工作时长"
        statement: "total_duration = sum(time_segment.duration_seconds)，自动聚合。"
        type: "policy"
        status: "planned"

        devlog_entry: "D35-Chronicle-AutoCalculation"

      POLICY-012:
        title: "TimeSegment 删除策略"
        statement: "删除 TimeSegment 时，自动清理关联的图片。删除 Session 时级联删除所有 TimeSegments。"
        type: "policy"
        status: "planned"

        devlog_entry: "D35-Chronicle-DeletionCleanup"

    events:
      SessionStarted:
        description: "工作会话开始"

      SessionEnded:
        description: "工作会话结束"

      TimeSegmentAdded:
        description: "添加时间分片"

      SessionReported:
        description: "会话统计报告生成"

# ============================================
# Domain 7: Media（媒体资源管理）
# ============================================

  media:
    name: "Media（媒体资源）"
    type: "ValueObject"
    description: "统一的媒体存储管理，支持图片、视频等多种类型。对应老架构中的 OrbitMediaResource。"
    status: "planned"

    # 从老架构的演变
    legacy_source: |
      - 对应老架构中的 OrbitMediaResource 表
      - 保留核心字段和存储策略
      - 新增支持的实体类型：BOOKSHELF_COVER, BOOK_COVER, BLOCK_IMAGE, CHRONICLE_ATTACHMENT
      - 改进存储路径管理

    invariants:
      RULE-024:
        title: "Media 必须关联到有效的 entity_type"
        statement: "entity_type 必须是预定义的类型之一（BOOKSHELF_COVER|BOOK_COVER|BLOCK_IMAGE|CHRONICLE_ATTACHMENT|...）。"
        type: "invariant"
        priority: "critical"
        status: "planned"

        devlog_entry: "D36-Media-EntityTypeValidation"

      RULE-025:
        title: "Media 必须有有效的 entity_id"
        statement: "entity_id 必须指向实际存在的实体，不能为 null。"
        type: "invariant"
        priority: "critical"
        status: "planned"

        devlog_entry: "D36-Media-EntityIdValidation"

      RULE-026:
        title: "Media 文件路径固定架构"
        statement: "文件存储路径格式：storage/{entity_type}/{entity_id}/。路径不可变。"
        type: "invariant"
        priority: "high"
        status: "planned"

        code_example: |
          # 示例路径
          storage/bookshelf_cover/bookshelf-uuid-123/cover.jpg
          storage/book_cover/book-uuid-456/preview.png
          storage/block_image/block-uuid-789/image-001.jpg
          storage/chronicle_attachment/session-uuid-000/screenshot.jpg

        devlog_entry: "D36-Media-FixedPathArchitecture"

    policies:
      POLICY-013:
        title: "Media 软删除策略"
        statement: "删除 Media 时，标记 deleted_at 而非物理删除，支持恢复。定期清理规则：deleted_at > 30 天时物理删除。"
        type: "policy"
        status: "planned"

        devlog_entry: "D36-Media-SoftDeletion"

      POLICY-014:
        title: "Media 关联实体删除"
        statement: "当关联的实体被删除时（如 Book 删除），自动标记其所有 Media 为软删除。"
        type: "policy"
        status: "planned"

        devlog_entry: "D36-Media-CascadingDeletion"

    events:
      MediaUploaded:
        description: "媒体文件被上传"

      MediaDeleted:
        description: "媒体文件被删除"

# ============================================
# Domain 8: Search（搜索 - 新增）
# ============================================

  search:
    name: "Search（搜索）"
    type: "Service"
    description: "全文搜索和高级过滤功能，支持基于 Books/Blocks 的内容搜索。"
    status: "planned"

    capabilities:
      - "按关键词全文搜索 Books 和 Blocks"
      - "按 Tag 过滤"
      - "按优先级/紧急度过滤"
      - "按创建/修改时间范围搜索"
      - "按 status 过滤"
      - "多条件组合查询"

    devlog_entry: "D37-Search-FulltextSupport"

# ============================================
# Domain 9: Stats（统计 - 新增）
# ============================================

  stats:
    name: "Stats（统计分析）"
    type: "Service"
    description: "统计数据聚合和分析，支持 Dashboard 展示和用户数据分析。"
    status: "planned"

    metrics:
      - "Books 总数、Bookshelves 总数、Blocks 总数"
      - "创建/修改时间趋势"
      - "Tag 使用频率分布"
      - "工作时间统计（来自 Chronicle）"
      - "热门标签排行"
      - "内容规模（字符数、代码行数）"

    devlog_entry: "D37-Stats-MetricsAggregation"

# ============================================
# Domain 10: Theme（主题 - 新增）
# ============================================

  theme:
    name: "Theme（主题系统）"
    type: "Service"
    description: "用户界面主题管理，支持多主题切换。"
    status: "planned"

    capabilities:
      - "预设主题（Light, Dark, Auto）"
      - "自定义主题配置"
      - "主题同步到所有设备"

    devlog_entry: "D37-Theme-UserPreferences"

# ============================================
# 跨域事件（Cross-Domain Events）
# ============================================

cross_domain_events:
  BookshelfDeleted:
    triggered_by: "bookshelf domain"
    listeners:
      - "block domain: cascade delete"
      - "media domain: cleanup references"
      - "search domain: remove index"
      - "stats domain: recalculate"

  BookDeleted:
    triggered_by: "book domain"
    listeners:
      - "block domain: cascade delete"
      - "media domain: cleanup references"
      - "chronicle domain: update session references"

  BlockDeleted:
    triggered_by: "block domain"
    listeners:
      - "media domain: cleanup references"
      - "search domain: remove from index"

  TagDeleted:
    triggered_by: "tag domain"
    listeners:
      - "book domain: remove tag associations"
      - "chronicle domain: remove from sessions"

# ============================================
# 实现计划（按优先级和依赖）
# ============================================

implementation_phases:

  phase_1_foundations:
    description: "基础设施和 Domain 层核心"
    estimated_duration: "2 weeks"
    rules:
      - RULE-001  # Library 单实例
      - RULE-004  # Bookshelf 无限创建
      - RULE-009  # Book 无限创建
      - RULE-013  # Block 无限创建
      - RULE-018  # Tag 唯一名称
      - RULE-024  # Media entity_type 验证

    tasks:
      - "创建各 domain/*.py 文件"
      - "定义 ORM Models"
      - "编写 Repository 接口"
      - "编写 Unit Tests for Domain"

  phase_2_relationships:
    description: "聚合根间的关系和依赖"
    estimated_duration: "1 week"
    rules:
      - RULE-002  # Library user association
      - RULE-005  # Bookshelf belongs to Library
      - RULE-010  # Book belongs to Bookshelf
      - RULE-016  # Block belongs to Book
      - RULE-019  # Tag-Book association

    tasks:
      - "实现 Foreign Key 约束"
      - "实现 Service 层的关系操作"
      - "编写集成测试"

  phase_3_policies:
    description: "业务政策和级联操作"
    estimated_duration: "1.5 weeks"
    policies:
      - POLICY-003  # Bookshelf deletion
      - POLICY-005  # Book deletion
      - POLICY-007  # Block deletion
      - POLICY-009  # Tag deletion
      - POLICY-013  # Media soft deletion

    tasks:
      - "实现级联删除逻辑"
      - "实现孤立处理逻辑"
      - "编写边界测试"

  phase_4_advanced_features:
    description: "高级功能（复制、转移、搜索、统计）"
    estimated_duration: "2 weeks"
    rules:
      - RULE-012  # Book duplication
      - RULE-017  # Block metadata

    tasks:
      - "实现 Book/Note 复制"
      - "实现 Book 转移"
      - "实现全文搜索（集成 PostgreSQL FTS）"
      - "实现统计汇聚"

  phase_5_chronicle:
    description: "时间追踪模块（独立迭代）"
    estimated_duration: "2 weeks"
    rules:
      - RULE-021  # Session start time
      - RULE-022  # TimeSegment validity
      - RULE-023  # Session book association

    tasks:
      - "实现 Session 和 TimeSegment 实体"
      - "实现时间自动计算"
      - "实现与 Wordloom 日记的集成"

# ============================================
# 验证和测试策略
# ============================================

testing_strategy:

  unit_tests:
    path: "backend/api/app/tests/test_*/test_domain.py"
    coverage_target: ">= 90%"
    focus:
      - "Invariants 验证"
      - "Value Objects 比较"
      - "Domain Logic 单元测试"

  integration_tests:
    path: "backend/api/app/tests/test_*/test_integration.py"
    coverage_target: ">= 80%"
    focus:
      - "Repository 实现"
      - "Service 业务逻辑"
      - "Domain Events 触发"
      - "级联操作（删除、转移）"

  api_tests:
    path: "backend/api/app/tests/test_*/test_router.py"
    coverage_target: ">= 75%"
    focus:
      - "API 端点验证"
      - "请求/响应 Schema"
      - "错误处理"
      - "权限校验"

  e2e_tests:
    path: "backend/api/app/tests/e2e/"
    coverage_target: ">= 50%"
    focus:
      - "完整工作流"
      - "Wordloom 日记集成"
      - "蓝绿部署验证"

# ============================================
# DevLog 和 PR 追踪
# ============================================

devlog_entries:
  D30:
    title: "Library Domain 定义"
    entries:
      - "D30-Library-SingleInstance"
      - "D30-Library-Identity"
      - "D30-Library-UserAssociation"

  D31:
    title: "Bookshelf Domain 定义"
    entries:
      - "D31-Bookshelf-Unlimited"
      - "D31-Bookshelf-BelongsToLibrary"
      - "D31-Bookshelf-NameNotEmpty"
      - "D31-Bookshelf-UnlimitedBooks"
      - "D31-Bookshelf-PriorityUrgency"

  D32:
    title: "Book Domain 定义"
    entries:
      - "D32-Book-Unlimited"
      - "D32-Book-BelongsToBookshelf"
      - "D32-Book-OrderedBlocks"
      - "D32-Bookshelf-CascadingDelete"
      - "D32-Bookshelf-MoveBooks"

  D33:
    title: "Block Domain 定义"
    entries:
      - "D33-Block-Unlimited"
      - "D33-Block-MustHaveType"
      - "D33-Block-Ordering"
      - "D33-Block-BelongsToBook"
      - "D33-Block-Metadata"
      - "D33-Book-CascadingDelete"
      - "D33-Book-Transfer"
      - "D33-Book-Duplication"

  D34:
    title: "Tag 和 Media Domain"
    entries:
      - "D34-Tag-UniqueName"
      - "D34-Tag-BookAssociation"
      - "D34-Tag-UIProperties"
      - "D34-Tag-MenubarIntegration"

  D35:
    title: "Chronicle 模块"
    entries:
      - "D35-Chronicle-SessionStartTime"
      - "D35-Chronicle-TimeSegmentValidity"
      - "D35-Chronicle-SessionBookAssociation"

  D36:
    title: "Media 资源管理"
    entries:
      - "D36-Media-EntityTypeValidation"
      - "D36-Media-EntityIdValidation"
      - "D36-Media-FixedPathArchitecture"

  D37:
    title: "Search 和 Stats 模块"
    entries:
      - "D37-Search-FulltextSupport"
      - "D37-Stats-MetricsAggregation"
      - "D37-Theme-UserPreferences"

# ============================================
# 规则变更历史
# ============================================

changelog:
  "2025-11-10":
    author: "Architecture Team"
    changes:
      - "Initial DDD Rules extraction from legacy architecture"
      - "Defined 25 core invariants and 14 business policies"
      - "Mapped 10 domains with clear responsibilities"
      - "Established 5-phase implementation plan"
