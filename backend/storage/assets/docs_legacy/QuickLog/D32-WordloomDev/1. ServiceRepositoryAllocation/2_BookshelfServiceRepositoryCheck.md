1️⃣ Bookshelf Service/Repository 完善性检查
┌────────────────────────────────────────────────────────────────────┐
│           Bookshelf Service 完善性评估（基于 DDD_RULES）           │
├────────────────────────────────────────────────────────────────────┤
│ 检查项                             │ 当前 │ 评分 │ 建议            │
├────────────────────────────────────────────────────────────────────┤
│ 【Layer 1: Validation】                                             │
├────────────────────────────────────────────────────────────────────┤
│ 1. create_bookshelf()              │  ✅  │ 4/5 │ 缺 user_id 验证│
│    - 检查 library_id 存在          │  ❌  │     │ 需要追加       │
│    - 检查重名（同 Library 内）     │  ❌  │     │ 需要追加       │
│    - 参数验证                      │  ✅  │     │ 完整           │
├────────────────────────────────────────────────────────────────────┤
│ 【Layer 2: Domain Logic】                                           │
├────────────────────────────────────────────────────────────────────┤
│ 2. get_bookshelf()                 │  ✅  │ 5/5 │ 完美           │
│    - 查询 + 异常处理               │  ✅  │     │                │
├────────────────────────────────────────────────────────────────────┤
│ 3. list_bookshelves()              │  ✅  │ 5/5 │ 完美           │
│    - 支持 RULE-005                 │  ✅  │     │                │
├────────────────────────────────────────────────────────────────────┤
│ 4. rename_bookshelf()              │  ✅  │ 5/5 │ 完美           │
│    - 调用 Domain 方法              │  ✅  │     │                │
│    - 同名检查                      │  ❌  │     │ 缺失          │
├────────────────────────────────────────────────────────────────────┤
│ 【Layer 3: Persistence】                                            │
├────────────────────────────────────────────────────────────────────┤
│ 5. set_description()               │  ✅  │ 4/5 │ 可移至辅助方法│
│    - 正确的持久化                  │  ✅  │     │                │
│    - 已标注为 Service 层            │  ✅  │     │                │
├────────────────────────────────────────────────────────────────────┤
│ 【Layer 4: Event Publishing】                                       │
├────────────────────────────────────────────────────────────────────┤
│ 6. 事件发布                        │  ❌  │ 0/5 │ ⚠️ 缺失!      │
│    - 收集 Domain Events            │  ❌  │     │ 需要添加       │
│    - 发布到 EventBus               │  ❌  │     │ 需要添加       │
├────────────────────────────────────────────────────────────────────┤
│ 【Auxiliary Features - 需要精简】                                   │
├────────────────────────────────────────────────────────────────────┤
│ 7. pin_bookshelf()                 │  ✅  │ 3/5 │ ✂️ 冗长        │
│    - 逻辑重复                      │  ⚠️  │     │ 可合并          │
│ 8. unpin_bookshelf()               │  ✅  │ 3/5 │ ✂️ 冗长        │
│ 9. favorite_bookshelf()            │  ✅  │ 3/5 │ ✂️ 冗长        │
│10. unfavorite_bookshelf()          │  ✅  │ 3/5 │ ✂️ 冗长        │
│                                    │     │     │ 建议提取辅助方法│
├────────────────────────────────────────────────────────────────────┤
│ 【Archive Operations】                                              │
├────────────────────────────────────────────────────────────────────┤
│11. archive_bookshelf()             │  ✅  │ 5/5 │ 完美           │
│12. unarchive_bookshelf()           │  ✅  │ 5/5 │ 完美           │
├────────────────────────────────────────────────────────────────────┤
│ 【Cascade & Deletion】                                              │
├────────────────────────────────────────────────────────────────────┤
│13. delete_bookshelf()              │  ⚠️  │ 2/5 │ ❌ 严重缺陷!   │
│    - 调用 Domain mark_deleted()    │  ✅  │     │                │
│    - 调用 repository.delete()      │  ❌  │     │ 错误!应只 save  │
│    - 缺 Books 级联处理             │  ❌  │     │ 需要处理       │
│    - 缺 Blocks 级联处理            │  ❌  │     │ 需要处理       │
│    - 缺 Media 清理                 │  ❌  │     │ 需要处理       │
├────────────────────────────────────────────────────────────────────┤
│ 【Query Methods】                                                   │
├────────────────────────────────────────────────────────────────────┤
│14. can_accept_books()              │  ✅  │ 5/5 │ 完美           │
│15. is_active()                     │  ✅  │ 5/5 │ 完美           │
│16. is_archived()                   │  ✅  │ 5/5 │ 完美           │
│17. is_deleted()                    │  ✅  │ 5/5 │ 完美           │
├────────────────────────────────────────────────────────────────────┤
│ 【缺失的关键方法】                                                  │
├────────────────────────────────────────────────────────────────────┤
│ ❌ get_basement_bookshelf()        │  ❌  │ 0/5 │ 必须添加!      │
│    - 获取 Basement（回收站）      │     │     │ 支持 RULE-010  │
├────────────────────────────────────────────────────────────────────┤
│ ❌ event_bus 支持                  │  ❌  │ 0/5 │ 必须添加!      │
│    - 初始化时缺失 event_bus        │     │     │ 接口设计       │
├────────────────────────────────────────────────────────────────────┤
│ 总体评分                           │   71/100  │ 需要改进       │
└────────────────────────────────────────────────────────────────────┘

2️⃣ Bookshelf Repository 完善性检查
┌────────────────────────────────────────────────────────────────────┐
│          Bookshelf Repository 完善性评估（基于 DDD_RULES）         │
├────────────────────────────────────────────────────────────────────┤
│ 检查项                             │ 当前 │ 评分 │ 建议            │
├────────────────────────────────────────────────────────────────────┤
│ 1. 抽象接口定义                    │  ✅  │ 5/5 │ 完美           │
│    - save()                        │  ✅  │     │                │
│    - get_by_id()                   │  ✅  │     │                │
│    - get_by_library_id() (RULE-005)│  ✅  │     │ ⭐ 正确        │
│    - delete()                      │  ✅  │     │                │
│    - exists()                      │  ✅  │     │                │
├────────────────────────────────────────────────────────────────────┤
│ 2. 具体实现（BookshelfRepositoryImpl) │ ✅ │ 3/5 │ 需要改进       │
│    - 依赖注入 session              │  ✅  │     │                │
│    - ORM ↔ Domain 转换             │  ✅  │     │                │
│    - 正确的查询逻辑                │  ✅  │     │                │
├────────────────────────────────────────────────────────────────────┤
│ 3. 错误处理                        │  ❌  │ 0/5 │ ❌ 完全缺失!   │
│    - 数据库连接失败                │  ❌  │     │                │
│    - 查询返回多条记录               │  ❌  │     │                │
│    - 约束冲突处理                  │  ❌  │     │                │
├────────────────────────────────────────────────────────────────────┤
│ 4. 事务管理                        │  ❌  │ 0/5 │ 缺失           │
│    - 在 save() 中没有提交          │  ❌  │     │ 应在 UoW 层    │
├────────────────────────────────────────────────────────────────────┤
│ 5. _to_domain() 转换               │  ✅  │ 5/5 │ 完美           │
│    - DRY 原则                      │  ✅  │     │ 已提取          │
│    - 所有字段映射                  │  ✅  │     │                │
├────────────────────────────────────────────────────────────────────┤
│ 6. 日志记录                        │  ❌  │ 0/5 │ 完全缺失       │
│    - 查询日志                      │  ❌  │     │                │
│    - 异常日志                      │  ❌  │     │                │
├────────────────────────────────────────────────────────────────────┤
│ 【缺失的查询方法】                                                  │
├────────────────────────────────────────────────────────────────────┤
│ ❌ get_basement_by_library_id()    │  ❌  │ 0/5 │ 必须添加!      │
│    - 查询特定 Library 的 Basement  │     │     │ 支持 RULE-010  │
├────────────────────────────────────────────────────────────────────┤
│ ❌ exists_by_name(library_id, name)│  ❌  │ 0/5 │ 需要添加       │
│    - 检查同 Library 内的重名       │     │     │ 支持重名检查    │
├────────────────────────────────────────────────────────────────────┤
│ 总体评分                           │   65/100  │ 需要改进       │
└────────────────────────────────────────────────────────────────────┘

